<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::main})}">
<head>
    <title>Analytics - SprintPilot</title>
</head>
<body>
    <main>
        <div class="space-y-6">
            <!-- Header Section - Exact React Match -->
            <div class="flex flex-col md:flex-row justify-between md:items-start gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Performance Analytics</h2>
                    <p class="text-gray-600">Review performance trends and identify opportunities for improvement.</p>
                </div>
                <button onclick="generatePerformanceInsights()" class="px-5 py-2.5 rounded-lg font-semibold text-sm transition-all duration-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center justify-center space-x-2 bg-primary-600 hover:bg-primary-700 text-white focus:ring-primary-500">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span>Generate Insights</span>
                </button>
            </div>

            <!-- Key Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200/80 p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-primary-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5">
                            <p class="text-sm font-medium text-gray-500">Avg Velocity</p>
                            <p class="text-2xl font-bold text-gray-900">98<span class="text-sm font-normal text-gray-500">sp</span></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="text-sm text-success font-medium">+12% from last sprint</div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200/80 p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-success/20 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5">
                            <p class="text-sm font-medium text-gray-500">Success Rate</p>
                            <p class="text-2xl font-bold text-gray-900">94<span class="text-sm font-normal text-gray-500">%</span></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="text-sm text-success font-medium">+3% from last month</div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200/80 p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-warning/20 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5">
                            <p class="text-sm font-medium text-gray-500">Cycle Time</p>
                            <p class="text-2xl font-bold text-gray-900">4.2<span class="text-sm font-normal text-gray-500">d</span></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="text-sm text-danger font-medium">+0.3d from baseline</div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200/80 p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5">
                            <p class="text-sm font-medium text-gray-500">Team Utilization</p>
                            <p class="text-2xl font-bold text-gray-900">87<span class="text-sm font-normal text-gray-500">%</span></p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="text-sm text-success font-medium">Optimal range</div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Velocity Trend Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200/80 p-6">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-3">Velocity Trend</h3>
                    <div class="h-64">
                        <canvas id="velocityChart"></canvas>
                    </div>
                </div>

                <!-- Work Distribution Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200/80 p-6">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-3">Work Distribution</h3>
                    <div class="h-80">
                            <canvas id="workDistributionChart"></canvas>
                    </div>
                </div>

                <!-- Team Performance Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200/80 p-6">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-3">Team Performance</h3>
                    <div class="h-64">
                        <canvas id="teamPerformanceChart"></canvas>
                    </div>
                </div>

                <!-- Burndown Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200/80 p-6">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-3">Sprint Burndown</h3>
                    <div class="h-64">
                        <canvas id="burndownChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- AI Insights Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200/80 p-6">
                <h3 class="text-xl font-bold text-gray-700 border-b pb-3 mb-4 flex items-center space-x-2">
                    <svg class="w-5 h-5 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                    <span>AI Performance Insights</span>
                </h3>
                <div id="insights-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                            <div class="flex items-center space-x-2 mb-2">
                                <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                <h4 class="font-semibold text-green-800">Trending Up</h4>
                            </div>
                            <p class="text-sm text-green-700">Team velocity has improved 15% over the last 3 sprints with consistent delivery patterns.</p>
                        </div>

                        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div class="flex items-center space-x-2 mb-2">
                                <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h4 class="font-semibold text-yellow-800">Watch Area</h4>
                            </div>
                            <p class="text-sm text-yellow-700">Backend team approaching 95% utilization. Consider load balancing or additional resources.</p>
                        </div>

                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-center space-x-2 mb-2">
                                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                                <h4 class="font-semibold text-blue-800">Optimization</h4>
                            </div>
                            <p class="text-sm text-blue-700">Good work-life balance maintained with 25% tech debt allocation supporting long-term velocity.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Insights Modal -->
            <div id="insightsModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
                    <h2 class="text-2xl font-bold text-gray-800 border-b pb-4 mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        AI Performance Insights
                    </h2>
                    <div id="modalInsightsContent" class="flex-grow overflow-y-auto pr-2">
                        <!-- Content will be loaded here -->
                    </div>
                    <div class="border-t pt-4 mt-4 flex justify-end">
                        <button onclick="closeInsightsModal()" class="px-5 py-2.5 rounded-lg font-semibold text-sm transition-all duration-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center justify-center space-x-2 bg-gray-200 hover:bg-gray-300 text-gray-800 focus:ring-gray-400">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let velocityChartInstance = null;
            let burndownChartInstance = null;
            let currentSprintId = null;

            // Initialize charts when page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Wait a bit for app.js to set the cookie
                setTimeout(() => {
                    currentSprintId = CookieUtils.getCookie('currentSprintId');
                    console.log('Current Sprint ID from cookie:', currentSprintId);
                    
                    if (currentSprintId) {
                        loadAnalyticsData();
                    } else {
                        console.warn('No current sprint ID found, loading with mock data');
                        initializeChartsWithMockData();
                    }
                }, 100);
            });

            async function loadAnalyticsData() {
                if (!currentSprintId) {
                    console.error('No sprint ID available');
                    initializeChartsWithMockData();
                    return;
                }

                console.log('Loading analytics data for sprint:', currentSprintId);

                try {
                    const response = await fetch('/api/sprints/metrics/burndown-velocity', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sprintId: currentSprintId
                        })
                    });
                    const data = await response.json();

                    console.log('Analytics response:', data);
                    console.log('Data structure:', JSON.stringify(data, null, 2));

                    if (data.success && data.data) {
                        console.log('Velocity data:', data.data.velocity);
                        console.log('Burndown data:', data.data.burndown);
                        
                        renderVelocityChart(data.data.velocity);
                        renderBurndownChart(data.data.burndown);
                        
                        // Load work distribution separately
                        loadWorkDistribution();
                        
                        // Still render team performance with mock data
                        renderTeamPerformanceChart();
                    } else {
                        console.error('Failed to load analytics data:', data.message);
                        initializeChartsWithMockData();
                    }
                } catch (error) {
                    console.error('Error loading analytics:', error);
                    initializeChartsWithMockData();
                }
            }

            function renderVelocityChart(velocityData) {
                console.log('renderVelocityChart called with:', velocityData);
                const velocityCtx = document.getElementById('velocityChart');

                // Destroy existing chart if it exists
                if (velocityChartInstance) {
                    velocityChartInstance.destroy();
                }

                if (!velocityData) {
                    console.error('velocityData is null/undefined');
                    const ctx = velocityCtx.getContext('2d');
                    ctx.font = '16px sans-serif';
                    ctx.fillStyle = '#9ca3af';
                    ctx.textAlign = 'center';
                    ctx.fillText('No velocity data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }

                // Extract data from the actual API response structure
                // historicalVelocity should be an array of objects with sprint data
                const historicalVelocity = velocityData.historicalVelocity || [];
                
                console.log('Historical velocity data:', historicalVelocity);
                console.log('Current sprint velocity:', velocityData.currentSprintVelocity);
                console.log('Committed points:', velocityData.committedPoints);
                console.log('Completed points:', velocityData.completedPoints);

                // If no historical data, show current sprint only
                if (!historicalVelocity || historicalVelocity.length === 0) {
                    // Show current sprint data only
                    const labels = ['Current Sprint'];
                    const completed = [velocityData.completedPoints || 0];
                    const committed = [velocityData.committedPoints || 0];

                    velocityChartInstance = new Chart(velocityCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Completed Story Points',
                                data: completed,
                                borderColor: '#4f46e5',
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                borderWidth: 3,
                                tension: 0.3,
                                fill: true,
                                pointRadius: 6,
                                pointHoverRadius: 8
                            }, {
                                label: 'Committed Story Points',
                                data: committed,
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                borderWidth: 2,
                                tension: 0.3,
                                fill: false,
                                pointRadius: 5,
                                pointHoverRadius: 7
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 15
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    padding: 12,
                                    cornerRadius: 8,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += context.parsed.y + ' SP';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Story Points',
                                        font: {
                                            size: 13,
                                            weight: 600
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                    return;
                }

                // Parse historical velocity data
                const labels = historicalVelocity.map(item => item.sprintName || item.name || 'Sprint');
                const completedData = historicalVelocity.map(item => item.completedPoints || item.completed || 0);
                const committedData = historicalVelocity.map(item => item.committedPoints || item.planned || item.committed || 0);

                console.log('Chart labels:', labels);
                console.log('Chart completed data:', completedData);
                console.log('Chart committed data:', committedData);

                velocityChartInstance = new Chart(velocityCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Completed Story Points',
                            data: completedData,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }, {
                            label: 'Committed Story Points',
                            data: committedData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y + ' SP';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Story Points',
                                    font: {
                                        size: 13,
                                        weight: 600
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            function renderBurndownChart(burndownData) {
                console.log('renderBurndownChart called with:', burndownData);
                const burndownCtx = document.getElementById('burndownChart');

                // Destroy existing chart if it exists
                if (burndownChartInstance) {
                    burndownChartInstance.destroy();
                }

                if (!burndownData) {
                    console.error('burndownData is null/undefined');
                    const ctx = burndownCtx.getContext('2d');
                    ctx.font = '16px sans-serif';
                    ctx.fillStyle = '#9ca3af';
                    ctx.textAlign = 'center';
                    ctx.fillText('No burndown data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }

                // Extract data from the actual API response structure
                const points = burndownData.points || [];
                const totalStoryPoints = burndownData.totalStoryPoints || 0;
                const startDate = burndownData.startDate;
                const endDate = burndownData.endDate;

                console.log('Burndown points array:', points);
                console.log('Total story points:', totalStoryPoints);
                console.log('Start date:', startDate, 'End date:', endDate);

                if (!points || points.length === 0) {
                    const ctx = burndownCtx.getContext('2d');
                    ctx.font = '16px sans-serif';
                    ctx.fillStyle = '#9ca3af';
                    ctx.textAlign = 'center';
                    ctx.fillText('No burndown data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }

                // Parse the points array - each point should have date and remaining points
                const labels = points.map(point => {
                    const dateStr = point.date || point.day || '';
                    if (!dateStr) return '';
                    
                    // Format date from "2025-12-01" to "Dec 1"
                    try {
                        const date = new Date(dateStr);
                        const month = date.toLocaleDateString('en-US', { month: 'short' });
                        const day = date.getDate();
                        return `${month} ${day}`;
                    } catch (e) {
                        // If parsing fails, just return the original
                        return dateStr;
                    }
                });
                const actualBurndown = points.map(point => point.remaining || point.remainingPoints || 0);
                
                // Calculate ideal burndown
                const idealBurndown = [];
                const pointsPerDay = totalStoryPoints / (points.length - 1 || 1);
                for (let i = 0; i < points.length; i++) {
                    idealBurndown.push(Math.max(0, totalStoryPoints - (pointsPerDay * i)));
                }

                console.log('Chart labels (dates):', labels);
                console.log('Actual burndown:', actualBurndown);
                console.log('Ideal burndown:', idealBurndown);

                burndownChartInstance = new Chart(burndownCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ideal Burndown',
                            data: idealBurndown,
                            borderColor: '#9ca3af',
                            backgroundColor: 'rgba(156, 163, 175, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            fill: false
                        }, {
                            label: 'Actual Burndown',
                            data: actualBurndown,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderWidth: 3,
                            tension: 0.1,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(2) + ' SP';
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Remaining Time Estimates',
                                    font: {
                                        size: 13,
                                        weight: 600
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Sprint Days',
                                    font: {
                                        size: 13,
                                        weight: 600
                                    }
                                },
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    autoSkip: true,
                                    maxTicksLimit: 15,
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        }
                    }
                });
            }

            let workDistributionChartInstance = null;

            async function loadWorkDistribution() {
                if (!currentSprintId) {
                    console.error('No sprint ID available for work distribution');
                    renderWorkDistributionChart(null);
                    return;
                }

                console.log('Loading work distribution for sprint:', currentSprintId);

                try {
                    const response = await fetch('/api/sprints/metrics/workDistribution', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sprintId: currentSprintId
                        })
                    });
                    const data = await response.json();

                    console.log('Work distribution response:', data);

                    if (data.success && data.data) {
                        renderWorkDistributionChart(data.data);
                    } else {
                        console.error('Failed to load work distribution:', data.message);
                        renderWorkDistributionChart(null);
                    }
                } catch (error) {
                    console.error('Error loading work distribution:', error);
                    renderWorkDistributionChart(null);
                }
            }

            function renderWorkDistributionChart(distributionData) {
                const workCtx = document.getElementById('workDistributionChart');

                // Destroy existing chart if it exists
                if (workDistributionChartInstance) {
                    workDistributionChartInstance.destroy();
                }

                // Use real data or fallback to mock
                let labels, data, colors;
                
                if (distributionData && distributionData.labels && distributionData.labels.length > 0) {
                    console.log('Rendering work distribution with real data:', distributionData);
                    labels = distributionData.labels;
                    data = distributionData.values.map(v => parseFloat(v));
                    
                    // Assign colors based on category
                    colors = labels.map(label => {
                        switch(label) {
                            case 'Features': return '#4f46e5';
                            case 'Tech Debt': return '#f59e0b';
                            case 'Bug Fixes': return '#ef4444';
                            case 'Support': return '#6b7280';
                            default: return '#9ca3af';
                        }
                    });
                } else {
                    console.log('No work distribution data, using mock data');
                    labels = ['Features', 'Tech Debt', 'Bug Fixes', 'Support'];
                    data = [60, 25, 12, 3];
                    colors = ['#4f46e5', '#f59e0b', '#ef4444', '#6b7280'];
                }

                workDistributionChartInstance = new Chart(workCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                left: 0,
                                right: 0,
                                top: 0,
                                bottom: 0
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'right',
                                align: 'center',
                                labels: {
                                    padding: 20,
                                    font: {
                                        size: 13,
                                        weight: 500
                                    },
                                    boxWidth: 20,
                                    boxHeight: 20,
                                    usePointStyle: false
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} tasks (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function renderTeamPerformanceChart() {
                const teamCtx = document.getElementById('teamPerformanceChart');
                new Chart(teamCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Alice (FE)', 'Bob (BE)', 'Charlie (QA)', 'David (BE)'],
                        datasets: [{
                            label: 'Utilization %',
                            data: [85, 95, 70, 88],
                            backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444'],
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Utilization %',
                                    font: {
                                        size: 13,
                                        weight: 600
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            function initializeChartsWithMockData() {
                // Velocity Trend Chart with mock data
                const velocityCtx = document.getElementById('velocityChart');
                new Chart(velocityCtx, {
                    type: 'line',
                    data: {
                        labels: ['Sprint 1', 'Sprint 2', 'Sprint 3', 'Sprint 4', 'Sprint 5', 'Sprint 6'],
                        datasets: [{
                            label: 'Completed Story Points',
                            data: [85, 92, 88, 95, 110, 125],
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            tension: 0.3,
                            fill: true
                        }, {
                            label: 'Planned Story Points',
                            data: [90, 95, 100, 105, 115, 130],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.3,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Story Points'
                                }
                            }
                        }
                    }
                });

                // Burndown Chart with mock data
                const burndownCtx = document.getElementById('burndownChart');
                new Chart(burndownCtx, {
                    type: 'line',
                    data: {
                        labels: ['Day 1', 'Day 3', 'Day 5', 'Day 7', 'Day 9', 'Day 11', 'Day 13', 'Day 15'],
                        datasets: [{
                            label: 'Ideal Burndown',
                            data: [125, 109, 94, 78, 63, 47, 31, 16, 0],
                            borderColor: 'rgba(128, 128, 128, 0.5)',
                            borderDash: [5, 5],
                            fill: false
                        }, {
                            label: 'Actual Burndown',
                            data: [125, 115, 98, 85, 72, 58, 45, 28, 15],
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Remaining Story Points'
                                }
                            }
                        }
                    }
                });

                // Render other charts with mock data
                renderWorkDistributionChart(null);
                renderTeamPerformanceChart();
            }

            function generatePerformanceInsights() {
                const modal = document.getElementById('insightsModal');
                const content = document.getElementById('modalInsightsContent');
                
                content.innerHTML = `
                    <div class="flex items-center justify-center h-48 text-gray-500">
                        <svg class="w-6 h-6 animate-pulse mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        Analyzing trends and generating insights...
                    </div>
                `;
                
                modal.classList.remove('hidden');
                
                // Call backend AI service
                fetch('/api/ai/performance-insights', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const insights = data.data;
                        // Convert markdown bullet points to HTML
                        const insightsHtml = insights.split('\n').filter(line => line.trim() !== '').map(line => {
                            const boldedLine = line.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900">$1</strong>');
                            const content = boldedLine.replace(/^- /, '').trim();
                            return `
                                <li class="flex items-start">
                                    <span class="text-primary-500 mr-2 mt-1">‚Ä¢</span>
                                    <span>${content}</span>
                                </li>
                            `;
                        }).join('');

                        content.innerHTML = `
                            <div class="text-sm text-gray-700 space-y-2 prose prose-sm max-w-none">
                                <ul class="space-y-2">${insightsHtml}</ul>
                            </div>
                        `;
                    } else {
                        content.innerHTML = `
                            <div class="text-center py-4 text-red-600">
                                <p>Failed to generate insights: ${data.message || 'Unknown error'}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error generating insights:', error);
                    // Fallback to mock response if API fails
                    content.innerHTML = `
                        <div class="text-sm text-gray-700 space-y-4">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="font-semibold text-green-800 mb-2">üéØ Performance Strengths</h4>
                                <ul class="space-y-1 text-green-700">
                                    <li>‚Ä¢ Consistent velocity improvement over 6 sprints (+18%)</li>
                                    <li>‚Ä¢ High sprint completion rate (94%)</li>
                                    <li>‚Ä¢ Excellent work-life balance maintenance</li>
                                    <li>‚Ä¢ Effective tech debt management (25% allocation)</li>
                                </ul>
                            </div>
                            
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <h4 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è Areas for Improvement</h4>
                                <ul class="space-y-1 text-yellow-700">
                                    <li>‚Ä¢ Backend team at 95% utilization (burnout risk)</li>
                                    <li>‚Ä¢ QA team underutilized at 70% (growth opportunity)</li>
                                    <li>‚Ä¢ Cycle time increasing for complex features (+0.3 days)</li>
                                    <li>‚Ä¢ Irregular burndown patterns in recent sprints</li>
                                </ul>
                            </div>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-800 mb-2">üìã Strategic Recommendations</h4>
                                <ol class="space-y-1 text-blue-700 list-decimal list-inside">
                                    <li>Add one junior backend developer to reduce load</li>
                                    <li>Cross-train QA team member in test automation</li>
                                    <li>Implement feature flagging for incremental delivery</li>
                                    <li>Schedule dedicated tech debt sprint every 4th iteration</li>
                                    <li>Establish daily check-ins for complex feature work</li>
                                </ol>
                            </div>
                            
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-2">üìä Key Performance Indicators</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <p class="text-gray-600">Average Velocity</p>
                                        <p class="font-bold text-lg">98 story points</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Velocity Variance</p>
                                        <p class="font-bold text-lg">¬±8% (Good)</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Sprint Predictability</p>
                                        <p class="font-bold text-lg">94% (Excellent)</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Team Satisfaction</p>
                                        <p class="font-bold text-lg">4.2/5 (High)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            function closeInsightsModal() {
                document.getElementById('insightsModal').classList.add('hidden');
            }

            // Close modal when clicking outside
            document.getElementById('insightsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeInsightsModal();
                }
            });
        </script>
    </main>
</body>
</html>