<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Task Planning - SprintPilot</title>
</head>
<body>
    <div th:fragment="content">
        <!-- Toast Notification Container -->
        <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
        
        <div class="space-y-8">
            <!-- Header Section - Exact React Match -->
            <div class="flex flex-col md:flex-row justify-between md:items-start gap-4">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Task Planning & Analysis</h2>
                    <p class="text-gray-500 mt-1">Import tasks, assign them to team members, and analyze potential risks.</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button onclick="openImportModal()" class="px-5 py-2.5 rounded-lg font-semibold text-sm transition-all duration-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center justify-center space-x-2 bg-green-600 hover:bg-green-700 text-white focus:ring-green-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        <span>Import Tasks</span>
                    </button>
                    <button onclick="analyzeTaskRisks()" class="px-5 py-2.5 rounded-lg font-semibold text-sm transition-all duration-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center justify-center space-x-2 bg-primary-600 hover:bg-primary-700 text-white focus:ring-primary-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <span id="analyzeButtonText">Analyze Task Risks</span>
                    </button>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button id="tasksTab" onclick="switchTab('tasks')" class="tab-button active border-primary-500 text-primary-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            Tasks
                        </button>
                        <button id="utilizationTab" onclick="switchTab('utilization')" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            Member Utilization
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Tasks Tab Content -->
            <div id="tasksTabContent" class="tab-content">
            <!-- Main Content Grid - Exact React Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Left Column - Sprint Backlog -->
                <div class="lg:col-span-3">
                    
                    <!-- 3 Risk Factor Cards -->
                    <div class="space-y-6">
                        
                        <!-- OFF TRACK Card -->
                        <div class="bg-white rounded-xl shadow-sm border-2 border-red-200">
                            <div class="p-4 bg-red-50 border-b border-red-200 flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-1 h-8 bg-red-500 rounded"></div>
                                    <div>
                                        <h4 class="text-lg font-bold text-red-700">Off Track</h4>
                                        <p class="text-xs text-red-600" id="offtrack-count">Loading...</p>
                                    </div>
                                    </div>
                                <span class="text-xs text-red-600 bg-red-100 px-3 py-1 rounded-full font-semibold">Requires Immediate Attention</span>
                                </div>
                            <div class="p-4">
                                <div id="offtrack-tasks" class="space-y-3 min-h-[100px]">
                                    <div class="text-center py-4 text-gray-500">
                                        <svg class="mx-auto h-8 w-8 text-gray-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <!-- Pagination for Off Track -->
                                <div id="offtrack-pagination" class="mt-4 pt-4 border-t border-red-100 flex items-center justify-between hidden">
                                    <div class="text-xs text-gray-600">
                                        <span id="offtrack-pagination-info"></span>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="loadOffTrackPage('prev')" id="offtrack-prev" class="px-3 py-1 text-xs bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                            Previous
                                        </button>
                                        <button onclick="loadOffTrackPage('next')" id="offtrack-next" class="px-3 py-1 text-xs bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                            Next
                                        </button>
                                    </div>
                                    </div>
                                </div>
                            </div>

                        <!-- AT RISK Card -->
                        <div class="bg-white rounded-xl shadow-sm border-2 border-yellow-200">
                            <div class="p-4 bg-yellow-50 border-b border-yellow-200 flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-1 h-8 bg-yellow-500 rounded"></div>
                                    <div>
                                        <h4 class="text-lg font-bold text-yellow-700">At Risk</h4>
                                        <p class="text-xs text-yellow-600" id="atrisk-count">Loading...</p>
                                    </div>
                                    </div>
                                <span class="text-xs text-yellow-600 bg-yellow-100 px-3 py-1 rounded-full font-semibold">May Need Attention</span>
                                </div>
                            <div class="p-4">
                                <div id="atrisk-tasks" class="space-y-3 min-h-[100px]">
                                    <div class="text-center py-4 text-gray-500">
                                        <svg class="mx-auto h-8 w-8 text-gray-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <!-- Pagination for At Risk -->
                                <div id="atrisk-pagination" class="mt-4 pt-4 border-t border-yellow-100 flex items-center justify-between hidden">
                                    <div class="text-xs text-gray-600">
                                        <span id="atrisk-pagination-info"></span>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="loadAtRiskPage('prev')" id="atrisk-prev" class="px-3 py-1 text-xs bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                            Previous
                                        </button>
                                        <button onclick="loadAtRiskPage('next')" id="atrisk-next" class="px-3 py-1 text-xs bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                            Next
                                        </button>
                                    </div>
                                    </div>
                                </div>
                            </div>

                        <!-- ON TRACK Card -->
                        <div class="bg-white rounded-xl shadow-sm border-2 border-green-200">
                            <div class="p-4 bg-green-50 border-b border-green-200 flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-1 h-8 bg-green-500 rounded"></div>
                                    <div>
                                        <h4 class="text-lg font-bold text-green-700">On Track</h4>
                                        <p class="text-xs text-green-600" id="ontrack-count">Loading...</p>
                                    </div>
                                    </div>
                                <span class="text-xs text-green-600 bg-green-100 px-3 py-1 rounded-full font-semibold">Progressing Well</span>
                                </div>
                            <div class="p-4">
                                <div id="ontrack-tasks" class="space-y-3 min-h-[100px]">
                                    <div class="text-center py-4 text-gray-500">
                                        <svg class="mx-auto h-8 w-8 text-gray-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <!-- Pagination for On Track -->
                                <div id="ontrack-pagination" class="mt-4 pt-4 border-t border-green-100 flex items-center justify-between hidden">
                                    <div class="text-xs text-gray-600">
                                        <span id="ontrack-pagination-info"></span>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button onclick="loadOnTrackPage('prev')" id="ontrack-prev" class="px-3 py-1 text-xs bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                            Previous
                                        </button>
                                        <button onclick="loadOnTrackPage('next')" id="ontrack-next" class="px-3 py-1 text-xs bg-white border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                            Next
                                        </button>
                                    </div>
                                    </div>
                                </div>
                            </div>

                    </div>
                </div>

                <!-- Right Column - AI Risk Summary -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200/80 p-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-700 border-b pb-3 flex items-center space-x-2">
                            <svg class="w-5 h-5 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            <span>AI Risk Summary</span>
                        </h3>
                        <div id="risk-summary-content">
                            <div class="text-center py-4">
                                <p class="text-gray-500 mb-4">Get a high-level summary of potential risks and bottlenecks.</p>
                                <button onclick="generateRiskSummary()" class="px-5 py-2.5 rounded-lg font-semibold text-sm transition-all duration-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center justify-center space-x-2 bg-primary-600 hover:bg-primary-700 text-white focus:ring-primary-500 mx-auto">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                    <span>Generate Risk Summary</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!-- End Tasks Tab Content -->

            <!-- Utilization Tab Content -->
            <div id="utilizationTabContent" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200/80 p-6">
                    <div class="flex items-center justify-end mb-6">
                        <button onclick="loadMemberUtilization()" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <span>Refresh</span>
                        </button>
                    </div>

                    <!-- Utilization Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h4 class="font-semibold text-red-700">Over-Utilized</h4>
                            </div>
                            <p class="text-2xl font-bold text-red-600 mt-2" id="overUtilizedCount">0</p>
                            <p class="text-sm text-red-600">members</p>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h4 class="font-semibold text-green-700">Properly Utilized</h4>
                            </div>
                            <p class="text-2xl font-bold text-green-600 mt-2" id="properlyUtilizedCount">0</p>
                            <p class="text-sm text-green-600">members</p>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center space-x-2">
                                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h4 class="font-semibold text-yellow-700">Under-Utilized</h4>
                            </div>
                            <p class="text-2xl font-bold text-yellow-600 mt-2" id="underUtilizedCount">0</p>
                            <p class="text-sm text-yellow-600">members</p>
                        </div>
                    </div>

                    <!-- Member Utilization Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member Name</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining Work (hrs)</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Capacity (hrs)</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Gap (hrs)</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="utilizationTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                        <svg class="mx-auto h-12 w-12 text-gray-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <p class="mt-2">Loading utilization data...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- End Utilization Tab Content -->
        </div>

        <!-- Import Tasks Modal - Matching React Design -->
        <div id="importModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50" onclick="closeImportModal(event)">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-6 border-b">
                    <h3 class="text-2xl font-bold text-gray-800">Import Tasks</h3>
                    <button onclick="closeImportModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Modal Content -->
                <div class="p-6">
                    <!-- Import Method Tabs -->
                    <div class="flex mb-6 bg-gray-100 p-1 rounded-lg">
                        <button id="csvTab" onclick="switchImportTab('csv')" class="flex-1 px-4 py-2 rounded-md text-sm font-semibold transition-colors duration-200 bg-white text-primary-600 shadow-sm">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                            CSV Upload
                        </button>
                        <button id="jiraTab" onclick="switchImportTab('jira')" class="flex-1 px-4 py-2 rounded-md text-sm font-semibold transition-colors duration-200 text-gray-600 hover:bg-white hover:text-primary-600">
                            <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                            </svg>
                            Jira Integration
                        </button>
                    </div>

                    <!-- CSV Import Tab -->
                    <div id="csvImportContent" class="import-tab-content">
                        <div class="space-y-6">
                            <!-- File Upload Area -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                <div id="fileDropArea" class="space-y-4">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <div class="text-center">
                                        <p class="text-lg font-medium text-gray-900">Upload CSV File</p>
                                        <p class="text-sm text-gray-500">Drag and drop or click to select</p>
                                    </div>
                                    <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                                    <button onclick="document.getElementById('csvFileInput').click()" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
                                        Choose File
                                    </button>
                                </div>
                            </div>

                            <!-- File Preview -->
                            <div id="filePreview" class="hidden space-y-4">
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <svg class="w-5 h-5 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div>
                                            <p class="font-medium text-green-800" id="fileName">File uploaded successfully</p>
                                            <p class="text-sm text-green-600" id="fileInfo">Ready to import</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Column Mapping -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3">Column Mapping</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Task Key Column</label>
                                            <select id="taskKeyColumn" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
                                                <option value="">Select column...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Summary Column</label>
                                            <select id="summaryColumn" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
                                                <option value="">Select column...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Story Points Column</label>
                                            <select id="storyPointsColumn" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
                                                <option value="">Select column...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Assignee Column</label>
                                            <select id="assigneeColumn" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
                                                <option value="">Select column...</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sample CSV Format -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-800 mb-2">Expected CSV Format</h4>
                                <div class="text-sm text-blue-600 font-mono bg-white p-3 rounded border">
                                    Task Key,Summary,Description,Story Points,Category,Priority,Assignee<br/>
                                    PROJ-101,"Implement dashboard","Dashboard redesign",8,FEATURE,HIGH,alice@company.com<br/>
                                    PROJ-102,"Fix login bug","Login timeout issue",3,PROD_ISSUE,CRITICAL,bob@company.com
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Jira Import Tab -->
                    <div id="jiraImportContent" class="import-tab-content hidden">
                        <div class="space-y-6">
                            <!-- Jira Connection -->
                            <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg p-6 text-white">
                                <div class="flex items-center space-x-3">
                                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 6.621 5.367 11.988 11.988 11.988s11.988-5.367 11.988-11.988C23.984 5.367 18.617.001 12.017.001zM8.384 12.014l-3.446-3.451c-.953-.953-.953-2.497 0-3.45s2.497-.953 3.45 0l3.451 3.446c.474.473.474 1.241 0 1.714L8.384 12.014zm7.232 0l-3.446 3.451c-.474.473-.474 1.241 0 1.714l3.451-3.446c.953-.953.953-2.497 0-3.45s-2.497-.953-3.45 0l3.445 3.446c.473.474 1.241.474 1.714 0z"/>
                                    </svg>
                                    <div>
                                        <h3 class="text-xl font-bold">Connect to Jira</h3>
                                        <p class="text-blue-100">Import tasks directly from your Jira project</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Jira Configuration Form -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-3">Project Key</label>
                                    <input type="text" id="jiraProject" placeholder="PROJ" oninput="updateImportButton()" class="w-full px-4 py-3 border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-base">
                            </div>

                            <!-- JQL Query -->
                            <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-3">JQL Query (Optional)</label>
                                    <textarea id="jqlQuery" rows="4" placeholder="project = PROJ AND status != Done" class="w-full px-4 py-3 border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 text-base resize-none"></textarea>
                                    <p class="text-sm text-gray-500 mt-2">Leave empty to import all issues of current sprint</p>
                            </div>
                            </div>
                        </div>
                    </div>

                    <!-- Import Actions -->
                    <div class="flex justify-end space-x-4 mt-8 pt-6 border-t">
                        <button onclick="closeImportModal()" class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                            Cancel
                        </button>
                        <button id="importButton" onclick="importTasks()" class="px-6 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            Import Tasks
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Include ApiService -->
        <script th:src="@{/js/app.js}"></script>

        <script>
            let analysisComplete = false;
            let csvData = null;
            let activeImportTab = 'csv';
            let currentSprintId = null;
            let currentTasks = [];

            // Toast Notification Function
            function showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toastId = 'toast-' + Date.now();
                
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    info: 'bg-blue-500',
                    warning: 'bg-yellow-500'
                };
                
                const icons = {
                    success: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`,
                    error: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`,
                    info: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                    warning: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>`
                };
                
                const toast = document.createElement('div');
                toast.id = toastId;
                toast.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 min-w-[300px] transform transition-all duration-300 translate-x-full opacity-0`;
                toast.innerHTML = `
                    ${icons[type]}
                    <span class="flex-1">${message}</span>
                    <button onclick="removeToast('${toastId}')" class="text-white hover:text-gray-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                
                container.appendChild(toast);
                
                // Trigger animation
                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                }, 10);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    removeToast(toastId);
                }, 5000);
            }
            
            function removeToast(toastId) {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }
            }

            // Initialize sprint ID from cookie
            function initializeSprintId() {
                // Try to get sprint ID from cookie first
                currentSprintId = CookieUtils.getCookie('currentSprintId');
                
                // If no cookie exists, try to get from URL parameter
                if (!currentSprintId) {
                    const urlParams = new URLSearchParams(window.location.search);
                    currentSprintId = urlParams.get('sprintId');
                }
                
                // Fall back to default if still not set
                if (!currentSprintId) {
                    currentSprintId = 'current-sprint';
                }
                
                // Save to cookie for future use
                CookieUtils.setCookie('currentSprintId', currentSprintId);
                
                console.log('Using Sprint ID from cookie:', currentSprintId);
            }
            
            // Function to change sprint ID (can be called from UI or other pages)
            function changeSprintId(newSprintId) {
                currentSprintId = newSprintId;
                CookieUtils.setCookie('currentSprintId', currentSprintId);
                
                // Reload tasks for new sprint
                loadTasks();
                
                console.log('Sprint ID changed to:', currentSprintId);
            }

            // Load tasks when page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializeSprintId();
                loadTasks();
                setupDragAndDrop();
            });

            // Pagination state for each risk factor
            const paginationState = {
                offtrack: { currentPage: 0, totalPages: 0, hasNext: false, hasPrevious: false },
                atrisk: { currentPage: 0, totalPages: 0, hasNext: false, hasPrevious: false },
                ontrack: { currentPage: 0, totalPages: 0, hasNext: false, hasPrevious: false }
            };

            // Fetch tasks from API - load all 3 sections
            async function loadTasks() {
                console.log('loadTasks() called with sprintId:', currentSprintId);
                
                if (!currentSprintId) {
                    console.error('No sprint ID available');
                    return;
                }
                
                // Load all 3 sections in parallel
                await Promise.all([
                    loadOffTrackTasks(0),
                    loadAtRiskTasks(0),
                    loadOnTrackTasks(0)
                ]);
            }

            // Load Off Track tasks
            async function loadOffTrackTasks(page = 0, size = 10) {
                try {
                    console.log('Loading OFF_TRACK tasks - Sprint:', currentSprintId, 'Page:', page, 'Size:', size);
                    const response = await ApiService.getTasksBySprintId(currentSprintId, 'OFF_TRACK', page, size);
                    console.log('OFF_TRACK response:', response);
                    if (response && response.success && response.data) {
                        renderTasksInSection('offtrack', response.data.tasks);
                        updatePaginationForSection('offtrack', response.data);
                    } else {
                        console.warn('OFF_TRACK - No data or unsuccessful response');
                    }
                } catch (error) {
                    console.error('Failed to load Off Track tasks:', error);
                    document.getElementById('offtrack-tasks').innerHTML = '<div class="text-center py-4 text-red-500">Failed to load tasks</div>';
                }
            }

            // Load At Risk tasks
            async function loadAtRiskTasks(page = 0, size = 10) {
                try {
                    console.log('Loading AT_RISK tasks - Sprint:', currentSprintId, 'Page:', page, 'Size:', size);
                    const response = await ApiService.getTasksBySprintId(currentSprintId, 'AT_RISK', page, size);
                    console.log('AT_RISK response:', response);
                    if (response && response.success && response.data) {
                        renderTasksInSection('atrisk', response.data.tasks);
                        updatePaginationForSection('atrisk', response.data);
                    } else {
                        console.warn('AT_RISK - No data or unsuccessful response');
                    }
                } catch (error) {
                    console.error('Failed to load At Risk tasks:', error);
                    document.getElementById('atrisk-tasks').innerHTML = '<div class="text-center py-4 text-yellow-500">Failed to load tasks</div>';
                }
            }

            // Load On Track tasks
            async function loadOnTrackTasks(page = 0, size = 10) {
                try {
                    console.log('Loading ON_TRACK tasks - Sprint:', currentSprintId, 'Page:', page, 'Size:', size);
                    const response = await ApiService.getTasksBySprintId(currentSprintId, 'ON_TRACK', page, size);
                    console.log('ON_TRACK response:', response);
                    if (response && response.success && response.data) {
                        renderTasksInSection('ontrack', response.data.tasks);
                        updatePaginationForSection('ontrack', response.data);
                    } else {
                        console.warn('ON_TRACK - No data or unsuccessful response');
                    }
                } catch (error) {
                    console.error('Failed to load On Track tasks:', error);
                    document.getElementById('ontrack-tasks').innerHTML = '<div class="text-center py-4 text-green-500">Failed to load tasks</div>';
                }
            }

            // Pagination handlers for each section
            async function loadOffTrackPage(direction) {
                const currentPage = paginationState.offtrack.currentPage;
                const newPage = direction === 'next' ? currentPage + 1 : currentPage - 1;
                await loadOffTrackTasks(newPage);
            }

            async function loadAtRiskPage(direction) {
                const currentPage = paginationState.atrisk.currentPage;
                const newPage = direction === 'next' ? currentPage + 1 : currentPage - 1;
                await loadAtRiskTasks(newPage);
            }

            async function loadOnTrackPage(direction) {
                const currentPage = paginationState.ontrack.currentPage;
                const newPage = direction === 'next' ? currentPage + 1 : currentPage - 1;
                await loadOnTrackTasks(newPage);
            }

            // Render tasks in a specific section
            function renderTasksInSection(section, tasks) {
                const container = document.getElementById(`${section}-tasks`);
                const countElement = document.getElementById(`${section}-count`);
                
                if (tasks.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <p class="text-sm">No tasks in this category</p>
                        </div>
                    `;
                    countElement.textContent = '0 tasks';
                } else {
                    const html = tasks.map(task => createTaskHTML(task)).join('');
                    container.innerHTML = html;
                    countElement.textContent = `${paginationState[section].totalElements || tasks.length} tasks`;
                }
            }

            // Update pagination controls for a section
            function updatePaginationForSection(section, pageData) {
                paginationState[section] = {
                    currentPage: pageData.currentPage,
                    totalPages: pageData.totalPages,
                    totalElements: pageData.totalElements,
                    hasNext: pageData.hasNext,
                    hasPrevious: pageData.hasPrevious
                };

                // Update count display
                const countElement = document.getElementById(`${section}-count`);
                countElement.textContent = `${pageData.totalElements} tasks`;

                // Update pagination controls
                const paginationContainer = document.getElementById(`${section}-pagination`);
                const paginationInfo = document.getElementById(`${section}-pagination-info`);
                const prevBtn = document.getElementById(`${section}-prev`);
                const nextBtn = document.getElementById(`${section}-next`);

                // Show/hide pagination based on whether there are multiple pages
                if (pageData.totalPages > 1) {
                    paginationContainer.classList.remove('hidden');
                    
                    const start = pageData.currentPage * pageData.pageSize + 1;
                    const end = Math.min((pageData.currentPage + 1) * pageData.pageSize, pageData.totalElements);
                    paginationInfo.textContent = `Showing ${start}-${end} of ${pageData.totalElements}`;

                    prevBtn.disabled = !pageData.hasPrevious;
                    nextBtn.disabled = !pageData.hasNext;
                } else {
                    paginationContainer.classList.add('hidden');
                }
            }

            // Create HTML for a single task
            function createTaskHTML(task) {
                // Use backend risk factor, default to ON_TRACK if null
                const riskLevel = getRiskLevelDisplay(task.riskFactor);
                const riskColors = {
                    'On Track': { border: 'green-500', bg: '', text: 'green-500', icon: 'M5 13l4 4L19 7' },
                    'At Risk': { border: 'yellow-500', bg: 'bg-yellow-50/50', text: 'yellow-500', icon: 'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
                    'Off Track': { border: 'red-500', bg: 'bg-red-50/50', text: 'red-500', icon: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z' }
                };
                const risk = riskColors[riskLevel];
                
                return `
                    <div class="p-4 rounded-lg bg-white shadow-sm border border-gray-200 border-l-4 border-${risk.border} ${risk.bg}">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-gray-800">${task.taskKey}: ${task.summary}</p>
                                <p class="text-sm text-gray-500">${task.category} â€¢ ${task.storyPoints} hours</p>
                            </div>
                            <div class="flex items-center space-x-2 text-sm font-semibold" title="${getRiskTooltip(riskLevel)}">
                                <svg class="w-5 h-5 text-${risk.text}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${risk.icon}"></path>
                                </svg>
                                <span>${riskLevel}</span>
                            </div>
                        </div>
                        <div class="mt-3 flex items-center justify-between">
                            <div class="w-1/2">
                                <span class="block text-sm font-medium text-gray-700">
                                    ${task.assigneeName ? task.assigneeName : 'Unassigned'}
                                </span>
                            </div>
                            <div class="text-xs text-gray-500 text-right">
                                <p>Start: ${task.startDate || 'N/A'} | Due: ${task.dueDate || 'N/A'}</p>
                                <p>Spent: ${task.timeSpent || 0}h</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Convert backend risk factor to display text
            function getRiskLevelDisplay(riskFactor) {
                if (!riskFactor) return 'On Track'; // Default if null
                
                const riskMap = {
                    'ON_TRACK': 'On Track',
                    'AT_RISK': 'At Risk',
                    'OFF_TRACK': 'Off Track'
                };
                return riskMap[riskFactor] || 'On Track';
            }

            // Get risk tooltip text
            function getRiskTooltip(riskLevel) {
                const tooltips = {
                    'On Track': 'Task is progressing well',
                    'At Risk': 'May need attention',
                    'Off Track': 'Requires immediate attention'
                };
                return tooltips[riskLevel] || '';
            }

            async function analyzeTaskRisks() {
                const button = document.getElementById('analyzeButtonText');
                const originalText = button.textContent;
                
                // Show loading state
                button.textContent = 'Analyzing...';
                button.parentElement.disabled = true;
                showToast('Starting risk analysis...', 'info');
                
                try {
                    // Call backend API to analyze risks
                    const response = await fetch('/api/tasks/analyze-risks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        button.textContent = 'Analysis Complete';
                button.parentElement.classList.remove('bg-primary-600', 'hover:bg-primary-700');
                button.parentElement.classList.add('bg-gray-400', 'cursor-not-allowed');
                
                        showToast(`Risk analysis completed! ${data.data} task${data.data !== 1 ? 's' : ''} analyzed successfully.`, 'success');
                        
                        // Reload tasks to show updated risk factors
                        await loadTasks();
                        
                        // Scroll to top to see grouped results
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        button.textContent = originalText;
                        button.parentElement.disabled = false;
                        showToast('Analysis failed: ' + (data.message || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Failed to analyze risks:', error);
                    button.textContent = originalText;
                    button.parentElement.disabled = false;
                    showToast('Failed to analyze risks. Please check your connection and try again.', 'error');
                }
            }

            function generateRiskSummary() {
                const content = document.getElementById('risk-summary-content');
                content.innerHTML = `
                    <div class="flex items-center justify-center h-32 text-gray-500">
                        <svg class="w-5 h-5 animate-pulse mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        Generating summary...
                    </div>
                `;
                
                // Call backend AI service
                fetch('/api/ai/risk-summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const summary = data.data;
                        const summaryHtml = summary.split('\n').filter(line => line.trim() !== '').map(line => {
                            const boldedLine = line.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900">$1</strong>');
                            const content = boldedLine.replace(/^- /, '').trim();
                            return `
                                <li class="flex items-start">
                                    <span class="text-primary-500 mr-2 mt-1">â€¢</span>
                                    <span>${content}</span>
                                </li>
                            `;
                        }).join('');
                        
                        content.innerHTML = `
                            <div class="text-gray-600 space-y-2 text-sm">
                                <ul class="space-y-2">${summaryHtml}</ul>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    // Fallback to mock response if API fails
                    setTimeout(() => {
                        content.innerHTML = `
                            <div class="text-gray-600 space-y-2 text-sm">
                                <ul class="space-y-2">
                                    <li class="flex items-start">
                                        <span class="text-primary-500 mr-2 mt-1">â€¢</span>
                                        <span><strong class="text-gray-900">Critical Issues:</strong> PROJ-103 is off track and blocking other tasks</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-primary-500 mr-2 mt-1">â€¢</span>
                                        <span><strong class="text-gray-900">At Risk Tasks:</strong> 2 tasks may need additional resources or timeline adjustment</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-primary-500 mr-2 mt-1">â€¢</span>
                                        <span><strong class="text-gray-900">Recommendations:</strong> Prioritize PROJ-103, reallocate resources from on-track tasks</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-primary-500 mr-2 mt-1">â€¢</span>
                                        <span><strong class="text-gray-900">Overall Status:</strong> Sprint goals achievable with immediate intervention</span>
                                    </li>
                                </ul>
                            </div>
                        `;
                    }, 2500);
                });
            }

            // Import Modal Functions
            function openImportModal() {
                document.getElementById('importModal').classList.remove('hidden');
                switchImportTab('csv'); // Default to CSV tab
            }

            function closeImportModal(event) {
                if (!event || event.target === event.currentTarget) {
                    document.getElementById('importModal').classList.add('hidden');
                    resetImportForm();
                }
            }

            function switchImportTab(tab) {
                activeImportTab = tab;
                
                // Update tab buttons
                document.getElementById('csvTab').classList.toggle('bg-white', tab === 'csv');
                document.getElementById('csvTab').classList.toggle('text-primary-600', tab === 'csv');
                document.getElementById('csvTab').classList.toggle('shadow-sm', tab === 'csv');
                document.getElementById('csvTab').classList.toggle('text-gray-600', tab !== 'csv');
                
                document.getElementById('jiraTab').classList.toggle('bg-white', tab === 'jira');
                document.getElementById('jiraTab').classList.toggle('text-primary-600', tab === 'jira');
                document.getElementById('jiraTab').classList.toggle('shadow-sm', tab === 'jira');
                document.getElementById('jiraTab').classList.toggle('text-gray-600', tab !== 'jira');
                
                // Show/hide content
                document.getElementById('csvImportContent').classList.toggle('hidden', tab !== 'csv');
                document.getElementById('jiraImportContent').classList.toggle('hidden', tab !== 'jira');
                
                // Update Import button style and state
                updateImportButton();
            }
            
            function updateImportButton() {
                const importButton = document.getElementById('importButton');
                
                if (activeImportTab === 'jira') {
                    // Jira tab - green button
                    importButton.className = 'px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed';
                    
                    // Enable/disable based on project key
                    const projectKey = document.getElementById('jiraProject').value.trim();
                    importButton.disabled = !projectKey;
                } else {
                    // CSV tab - primary button
                    importButton.className = 'px-6 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed';
                    
                    // Enable/disable based on CSV data
                    importButton.disabled = !csvData;
                }
            }

            function resetImportForm() {
                // Reset CSV form
                document.getElementById('csvFileInput').value = '';
                document.getElementById('filePreview').classList.add('hidden');
                csvData = null;
                
                // Reset Jira form
                document.getElementById('jiraProject').value = '';
                document.getElementById('jqlQuery').value = '';
                
                // Reset import button
                document.getElementById('importButton').disabled = true;
            }

            // Jira Import Function
            async function fetchJiraIssues() {
                if (!currentSprintId) {
                    showToast('No active sprint found', 'error');
                    return;
                }

                const projectKey = document.getElementById('jiraProject').value.trim();
                const jqlQuery = document.getElementById('jqlQuery').value.trim();

                if (!projectKey) {
                    showToast('Please enter a Project Key', 'error');
                    return;
                }

                console.log('Fetching Jira issues - Sprint:', currentSprintId, 'Project:', projectKey, 'JQL:', jqlQuery);

                try {
                    const response = await fetch('/api/tasks/import/jira', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sprintId: currentSprintId,
                            projectKey: projectKey,
                            jqlQuery: jqlQuery || null
                        })
                    });

                    const data = await response.json();
                    console.log('Jira import response:', data);

                    if (data.success) {
                        showToast('Successfully imported tasks', 'success');
                        closeImportModal();
                        // Reload tasks to show the new ones
                        await loadTasks();
                    } else {
                        showToast('Failed to import from Jira: ' + (data.message || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Failed to import from Jira:', error);
                    showToast('Failed to import from Jira. Please check your connection and try again.', 'error');
                }
            }

            // CSV Import Functions
            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    alert('Please select a CSV file.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    parseCSV(text, file.name);
                };
                reader.readAsText(file);
            }

            function parseCSV(text, fileName) {
                const lines = text.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    alert('CSV file must have at least a header row and one data row.');
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const rows = lines.slice(1).map(line => 
                    line.split(',').map(cell => cell.trim().replace(/"/g, ''))
                );
                
                csvData = { headers, rows };
                
                // Show file preview
                document.getElementById('fileName').textContent = fileName;
                document.getElementById('fileInfo').textContent = `${rows.length} tasks ready to import`;
                document.getElementById('filePreview').classList.remove('hidden');
                
                // Populate column mapping dropdowns
                populateColumnMappings(headers);
                
                // Enable import button
                document.getElementById('importButton').disabled = false;
            }

            function populateColumnMappings(headers) {
                const selects = ['taskKeyColumn', 'summaryColumn', 'storyPointsColumn', 'assigneeColumn'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Select column...</option>';
                    
                    headers.forEach((header, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = header;
                        
                        // Auto-select likely matches
                        if (selectId === 'taskKeyColumn' && header.toLowerCase().includes('key')) {
                            option.selected = true;
                        } else if (selectId === 'summaryColumn' && header.toLowerCase().includes('summary')) {
                            option.selected = true;
                        } else if (selectId === 'storyPointsColumn' && (header.toLowerCase().includes('points') || header.toLowerCase().includes('estimate'))) {
                            option.selected = true;
                        } else if (selectId === 'assigneeColumn' && (header.toLowerCase().includes('assignee') || header.toLowerCase().includes('owner'))) {
                            option.selected = true;
                        }
                        
                        select.appendChild(option);
                    });
                });
            }

            // Jira Import Functions

            // Import Tasks Function
            function importTasks() {
                if (activeImportTab === 'csv' && csvData) {
                    importFromCSV();
                } else if (activeImportTab === 'jira') {
                    fetchJiraIssues();
                }
            }

            function importFromCSV() {
                const taskKeyCol = document.getElementById('taskKeyColumn').value;
                const summaryCol = document.getElementById('summaryColumn').value;
                const storyPointsCol = document.getElementById('storyPointsColumn').value;
                const assigneeCol = document.getElementById('assigneeColumn').value;
                
                if (!taskKeyCol || !summaryCol) {
                    alert('Please map at least Task Key and Summary columns.');
                    return;
                }
                
                const tasks = csvData.rows.map(row => ({
                    taskKey: row[taskKeyCol] || '',
                    summary: row[summaryCol] || '',
                    storyPoints: storyPointsCol ? parseFloat(row[storyPointsCol]) || 0 : 0,
                    assignee: assigneeCol ? row[assigneeCol] || null : null,
                    category: 'FEATURE',
                    priority: 'MEDIUM',
                    status: 'TODO'
                }));
                
                // Mock import
                fetch('/api/tasks/import/csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tasks, sprintId: currentSprintId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(`Successfully imported ${tasks.length} tasks from CSV!`, 'success');
                        closeImportModal();
                        // Reload tasks from API
                        loadTasks();
                    } else {
                        showToast('Import failed: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    // Mock successful import for demo
                    setTimeout(() => {
                        showToast(`Successfully imported ${tasks.length} tasks from CSV!`, 'success');
                        closeImportModal();
                        // Reload tasks from API
                        loadTasks();
                    }, 1000);
                });
            }


            // Drag and drop support for CSV files
            function setupDragAndDrop() {
                const dropArea = document.getElementById('fileDropArea');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight(e) {
                    dropArea.classList.add('border-primary-400', 'bg-primary-50');
                }
                
                function unhighlight(e) {
                    dropArea.classList.remove('border-primary-400', 'bg-primary-50');
                }
                
                dropArea.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        document.getElementById('csvFileInput').files = files;
                        handleFileUpload({ target: { files: files } });
                    }
                }
            }

            // Tab Switching Functions
            function switchTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                // Remove active class from all tabs
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active', 'border-primary-500', 'text-primary-600');
                    button.classList.add('border-transparent', 'text-gray-500');
                });

                // Show selected tab content
                if (tabName === 'tasks') {
                    document.getElementById('tasksTabContent').classList.remove('hidden');
                    document.getElementById('tasksTab').classList.add('active', 'border-primary-500', 'text-primary-600');
                    document.getElementById('tasksTab').classList.remove('border-transparent', 'text-gray-500');
                } else if (tabName === 'utilization') {
                    document.getElementById('utilizationTabContent').classList.remove('hidden');
                    document.getElementById('utilizationTab').classList.add('active', 'border-primary-500', 'text-primary-600');
                    document.getElementById('utilizationTab').classList.remove('border-transparent', 'text-gray-500');
                    
                    // Load utilization data when tab is opened
                    loadMemberUtilization();
                }
            }

            // Load Member Utilization
            async function loadMemberUtilization() {
                if (!currentSprintId) {
                    console.error('No sprint ID available');
                    showToast('No active sprint found', 'error');
                    return;
                }

                console.log('Loading member utilization for sprint:', currentSprintId);
                
                try {
                    const response = await fetch(`/api/tasks/utilization/sprint/${currentSprintId}`);
                    const data = await response.json();

                    console.log('Utilization response:', data);

                    if (data.success && data.data) {
                        renderUtilizationData(data.data);
                    } else {
                        showToast('Failed to load utilization data: ' + (data.message || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Failed to load utilization:', error);
                    showToast('Failed to load utilization data', 'error');
                }
            }

            // Render Utilization Data
            function renderUtilizationData(utilizations) {
                console.log('Rendering utilization data:', utilizations);

                // Count by status
                let overUtilized = 0;
                let properlyUtilized = 0;
                let underUtilized = 0;

                utilizations.forEach(u => {
                    if (u.status === 'OVER_UTILIZED') overUtilized++;
                    else if (u.status === 'PROPERLY_UTILIZED') properlyUtilized++;
                    else if (u.status === 'UNDER_UTILIZED') underUtilized++;
                });

                // Update summary cards
                document.getElementById('overUtilizedCount').textContent = overUtilized;
                document.getElementById('properlyUtilizedCount').textContent = properlyUtilized;
                document.getElementById('underUtilizedCount').textContent = underUtilized;

                // Render table
                const tableBody = document.getElementById('utilizationTableBody');
                
                if (utilizations.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                No member utilization data found
                            </td>
                        </tr>
                    `;
                    return;
                }

                const rows = utilizations.map(u => {
                    const statusColors = {
                        'OVER_UTILIZED': 'bg-red-100 text-red-800',
                        'PROPERLY_UTILIZED': 'bg-green-100 text-green-800',
                        'UNDER_UTILIZED': 'bg-yellow-100 text-yellow-800'
                    };

                    const statusLabels = {
                        'OVER_UTILIZED': 'Over Utilized',
                        'PROPERLY_UTILIZED': 'Properly Utilized',
                        'UNDER_UTILIZED': 'Under Utilized'
                    };

                    const gapClass = u.gap > 0 ? 'text-red-600' : u.gap < 0 ? 'text-blue-600' : 'text-gray-600';

                    return `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${u.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-600">${Number(u.remainingEstimate).toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-600">${Number(u.capacity).toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${gapClass}">${Number(u.gap).toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColors[u.status]}">
                                    ${statusLabels[u.status]}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');

                tableBody.innerHTML = rows;
            }
        </script>
    </div>
</body>
</html>