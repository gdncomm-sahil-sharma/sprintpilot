<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Sprint Setup - SprintPilot</title>
</head>
<body>
    <div th:fragment="content">
        <!-- Toast Container -->
        <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-3 pointer-events-none">
            <!-- Toasts will be dynamically inserted here -->
        </div>
        
        <div class="space-y-6">
            
            <!-- Enhanced Professional Header -->
            <div class="bg-gradient-to-r from-primary-600 to-indigo-700 rounded-2xl shadow-xl p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-extrabold text-white flex items-center gap-3">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                            </svg>
                            Sprint Setup & Configuration
                        </h2>
                        <p class="text-primary-100 mt-1 text-sm">Configure sprint dates, meetings, and key events for your team</p>
                    </div>
                    <button onclick="saveSprintSettings()" class="px-6 py-3 rounded-xl font-bold text-sm transition-all duration-200 shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-white/30 flex items-center justify-center space-x-2 bg-white text-primary-700 hover:bg-primary-50 transform hover:scale-105">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Save Configuration</span>
                    </button>
                </div>
            </div>

            <!-- EXACT ORIGINAL LAYOUT -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Left Column - Configuration Cards -->
                <div class="lg:col-span-3 space-y-6">
                    
                    <!-- Enhanced Core Configuration Card -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-200/50 hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                        <div class="bg-gradient-to-r from-primary-50 to-indigo-50 px-6 py-4 border-b border-gray-200/50">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Core Configuration
                            </h3>
                            <p class="text-sm text-gray-600 mt-1">Define sprint timeline and duration</p>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <!-- Sprint Start Date -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-1.5">
                                        <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        Sprint Start Date
                                    </label>
                                    <input type="date" id="startDate" name="startDate" class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 hover:border-primary-300 transition-colors" onchange="calculateEndDate()" />
                                </div>
                                
                                <!-- Sprint Duration -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-1.5">
                                        <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Sprint Duration (working days)
                                    </label>
                                    <input type="number" id="duration" name="duration" value="14" min="1" class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 hover:border-primary-300 transition-colors" onchange="calculateEndDate()" />
                                </div>
                                
                                <!-- Sprint End Date (Calculated) -->
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-1.5">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Sprint End Date
                                        <span class="ml-auto text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">Auto-calculated</span>
                                    </label>
                                    <input type="date" id="endDate" name="endDate" readonly class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm bg-gradient-to-r from-gray-50 to-gray-100 cursor-not-allowed text-gray-700 font-semibold" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Sprint Meetings Card -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-200/50 hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-4 border-b border-gray-200/50">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                Sprint Meetings
                            </h3>
                            <p class="text-sm text-gray-600 mt-1 flex items-center gap-1.5">
                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                </svg>
                                Schedule key sprint ceremonies and generate AI-powered Outlook invites
                            </p>
                        </div>
                        <div class="p-6">
                        <div class="divide-y divide-gray-100">
                            <!-- Sprint Planning -->
                            <div class="py-4 first:pt-0 last:pb-0">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-gray-800">Sprint Planning</h4>
                                    <button onclick="generateInvite('planning')" class="px-4 py-2 rounded-xl font-semibold text-sm transition-all duration-200 shadow-sm hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center space-x-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white focus:ring-indigo-500 transform hover:scale-105">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                        </svg>
                                        <span>Generate Invite</span>
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <input type="date" id="planningDate" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="time" id="planningTime" value="10:00" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="number" id="planningDuration" value="120" min="30" placeholder="Duration (min)" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                </div>
                            </div>
                            
                            <!-- Backlog Grooming -->
                            <div class="py-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-gray-800">Backlog Grooming/Refinement</h4>
                                    <button onclick="generateInvite('grooming')" class="px-4 py-2 rounded-xl font-semibold text-sm transition-all duration-200 shadow-sm hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center space-x-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white focus:ring-indigo-500 transform hover:scale-105">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                        </svg>
                                        <span>Generate Invite</span>
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <input type="date" id="groomingDate" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="time" id="groomingTime" value="14:00" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="number" id="groomingDuration" value="90" min="30" placeholder="Duration (min)" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                </div>
                            </div>
                            
                            <!-- Sprint Retrospective -->
                            <div class="py-4 last:pb-0">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-gray-800">Sprint Retrospective</h4>
                                    <button onclick="generateInvite('retrospective')" class="px-4 py-2 rounded-xl font-semibold text-sm transition-all duration-200 shadow-sm hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center space-x-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white focus:ring-indigo-500 transform hover:scale-105">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                        </svg>
                                        <span>Generate Invite</span>
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <input type="date" id="retrospectiveDate" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="time" id="retrospectiveTime" value="15:00" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="number" id="retrospectiveDuration" value="90" min="30" placeholder="Duration (min)" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Enhanced Holiday & Deployment Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- HolidayManager -->
                        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/50 hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                            <div class="bg-gradient-to-r from-yellow-50 to-amber-50 px-6 py-4 border-b border-gray-200/50">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                    </svg>
                                    Sprint Holidays
                                </h3>
                                <p class="text-sm text-gray-600 mt-1">Mark non-working days</p>
                            </div>
                            <div class="p-6">
                            <!-- Global/Pre-configured Holidays Section -->
                            <div id="globalHolidaysSection" class="mb-6 hidden">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                        <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                                        </svg>
                                        Pre-configured Holidays
                                    </h4>
                                    <span class="text-xs text-green-700 bg-green-100 px-2 py-1 rounded-full font-medium flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Always Included
                                    </span>
                                </div>
                                <div id="globalHolidaysList" class="space-y-2 p-3 bg-yellow-50/30 rounded-lg border border-yellow-200/50 max-h-48 overflow-y-auto">
                                    <!-- Global holidays will be added here (always included) -->
                                </div>
                            </div>
                            
                            <!-- Manually Added Holidays Section -->
                            <div class="mb-4">
                                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                    <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Custom Holidays
                                </h4>
                            <div id="holidaysList" class="space-y-3 mb-4">
                                <!-- Manually added holidays will be dynamically added here -->
                            </div>
                            </div>
                            
                            <!-- Add Holiday Form -->
                            <div class="space-y-3 p-4 bg-gradient-to-br from-yellow-50/50 to-amber-50/50 rounded-xl border-2 border-dashed border-yellow-300">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Holiday Date</label>
                                    <input type="date" id="newHolidayDate" 
                                           class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 hover:border-yellow-300 transition-colors">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Holiday Name</label>
                                    <input type="text" id="newHolidayName" 
                                           class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 hover:border-yellow-300 transition-colors"
                                           placeholder="e.g., Diwali">
                                </div>
                                <button onclick="addHoliday()" 
                                        class="w-full px-4 py-3 bg-gradient-to-r from-yellow-500 to-amber-500 hover:from-yellow-600 hover:to-amber-600 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transform hover:scale-105">
                                    <span class="flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Add Holiday
                                    </span>
                                </button>
                            </div>
                            </div>
                        </div>
                        
                        <!-- DeploymentManager -->
                        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/50 hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 border-b border-gray-200/50">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                    </svg>
                                    Deployment Events
                                </h3>
                                <p class="text-sm text-gray-600 mt-1">Schedule production releases</p>
                            </div>
                            <div class="p-6">
                            <div id="deploymentsList" class="space-y-3 mb-4">
                                <!-- Deployments will be dynamically added here -->
                            </div>
                            
                            <!-- Add Deployment Form -->
                            <div class="space-y-3 p-4 bg-gradient-to-br from-green-50/50 to-emerald-50/50 rounded-xl border-2 border-dashed border-green-300">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Deployment Date</label>
                                    <input type="date" id="newDeploymentDate" 
                                           class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 hover:border-green-300 transition-colors">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Deployment Name</label>
                                    <input type="text" id="newDeploymentName" 
                                           class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 hover:border-green-300 transition-colors"
                                           placeholder="e.g., Production">
                                </div>
                                <button onclick="addDeployment()" 
                                        class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transform hover:scale-105">
                                    <span class="flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Add Deployment
                                    </span>
                                </button>
                            </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Code Freeze Dates (Optional) -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-200/50 hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                        <div class="bg-gradient-to-r from-orange-50 to-amber-50 px-6 py-4 border-b border-gray-200/50">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                                Code Freeze Dates
                                <span class="ml-2 text-xs font-normal bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">Optional</span>
                            </h3>
                            <p class="text-sm text-gray-600 mt-1">Lock code changes before deployments</p>
                        </div>
                        <div class="p-6">
                        <div id="codeFreezeList" class="space-y-3 mb-4">
                            <!-- Code freeze dates will be dynamically added here -->
                        </div>
                        
                        <!-- Add Code Freeze Form -->
                        <div class="space-y-3 p-4 bg-gradient-to-br from-orange-50/50 to-amber-50/50 rounded-xl border-2 border-dashed border-orange-300">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Code Freeze Date</label>
                                <input type="date" id="newCodeFreezeDate" 
                                       class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 hover:border-orange-300 transition-colors">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Description (Optional)</label>
                                <input type="text" id="newCodeFreezeName" 
                                       class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 hover:border-orange-300 transition-colors"
                                       placeholder="e.g., Pre-production freeze">
                            </div>
                            <button onclick="addCodeFreeze()" 
                                    class="w-full px-4 py-3 bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transform hover:scale-105">
                                <span class="flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Add Code Freeze
                                </span>
                            </button>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Enhanced Dynamic Timeline -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-200/50 hover:shadow-xl transition-shadow duration-300 overflow-hidden sticky top-4">
                        <div class="bg-gradient-to-r from-primary-50 to-blue-50 px-6 py-4 border-b border-gray-200/50">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Sprint Timeline
                            </h3>
                            <p class="text-sm text-gray-600 mt-1">Visual overview of all sprint events</p>
                        </div>
                        <div class="p-6 max-h-[800px] overflow-y-auto custom-scrollbar">
                        <div class="relative pl-6">
                            <div class="absolute left-0 top-0 bottom-0 w-0.5 bg-gradient-to-b from-primary-300 via-primary-200 to-primary-300"></div>
                            <!-- All timeline items will be rendered here dynamically -->
                            <div id="timelineContainer" class="space-y-6"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Custom Scrollbar Styling -->
        <style>
            .custom-scrollbar::-webkit-scrollbar {
                width: 8px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: linear-gradient(to bottom, #3b82f6, #6366f1);
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(to bottom, #2563eb, #4f46e5);
            }
        </style>

        <!-- Template Selection Modal - MINIMAL ADDITION -->
        <div id="templateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50" onclick="closeTemplateModal(event)">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-800">Choose Sprint Template</h3>
                    <button onclick="closeTemplateModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="p-4">
                    <div class="space-y-2 max-h-60 overflow-y-auto mb-4">
                        <div th:each="template : ${sprintTemplates}" 
                             th:onclick="'selectTemplate(\'' + ${template.id()} + '\', ' + ${template.duration()} + ')'"
                             class="p-3 border border-gray-200 rounded hover:border-primary-300 hover:bg-primary-50 cursor-pointer transition-colors">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-medium text-gray-800" th:text="${template.startDate()} + ' ‚Üí ' + ${template.endDate()}"></p>
                                    <p class="text-xs text-gray-500" th:text="${template.duration()} + ' days'"></p>
                                </div>
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Completed</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">New Sprint Start Date</label>
                        <input type="date" id="templateStartDate" class="block w-full border-gray-300 rounded-lg shadow-sm p-2 text-sm focus:ring-primary-500 focus:border-primary-500" />
                    </div>
                    
                    <div class="flex justify-end gap-2">
                        <button onclick="closeTemplateModal()" class="px-3 py-1 border border-gray-300 rounded text-sm text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button id="applyTemplateBtn" onclick="applySelectedTemplate()" class="px-3 py-1 bg-primary-600 text-white text-sm rounded hover:bg-primary-700 disabled:opacity-50" disabled>
                            Apply Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Meeting Invite Modal -->
        <div id="inviteModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-6 border-b bg-gradient-to-r from-primary-50 to-primary-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-primary-600 flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">AI-Generated Meeting Invite</h3>
                            <p class="text-sm text-gray-600" id="inviteMeetingType">Sprint Meeting</p>
                        </div>
                    </div>
                    <button onclick="closeInviteModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Body -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Loading State -->
                    <div id="inviteLoading" class="hidden text-center py-12">
                        <svg class="animate-spin h-12 w-12 text-primary-600 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-gray-600 font-medium">ü§ñ AI is crafting your perfect invite...</p>
                        <p class="text-sm text-gray-500 mt-2">This may take a few seconds</p>
                    </div>
                    
                    <!-- Invite Content -->
                    <div id="inviteContent" class="hidden space-y-6">
                        <!-- Subject -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                                </svg>
                                Subject
                            </label>
                            <input type="text" id="inviteSubject" readonly 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-800 font-medium focus:outline-none focus:ring-2 focus:ring-primary-500" />
                        </div>
                        
                        <!-- Meeting Details -->
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">üìÖ Date</label>
                                <input type="text" id="inviteDate" readonly 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm" />
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">‚è∞ Time</label>
                                <input type="text" id="inviteTime" readonly 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm" />
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">‚è±Ô∏è Duration</label>
                                <input type="text" id="inviteDuration" readonly 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm" />
                            </div>
                        </div>
                        
                        <!-- Body -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Invite Content
                            </label>
                            <div id="inviteBodyDisplay" 
                                 class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 max-h-96 overflow-y-auto"
                                 style="white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6;">
                            </div>
                            <textarea id="inviteBody" class="hidden"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="border-t p-6 bg-gray-50">
                    <div class="flex justify-between items-center">
                        <button onclick="copyInviteToClipboard()" 
                                class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy
                        </button>
                        <div class="flex gap-3">
                            <button onclick="closeInviteModal()" 
                                    class="px-5 py-2.5 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                Close
                            </button>
                            <button onclick="openInOutlook()" 
                                    class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors flex items-center gap-2 shadow-sm">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M7 18h10v-2H7v2zM21 11h-8V9h8v2zm0-6h-8V3h8v2zM3 9a2 2 0 012-2h4a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V9zm2 0h4v10H5V9z"/>
                                </svg>
                                Open in Outlook
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXACT ORIGINAL JavaScript with new functionality added -->
        <script>
            let selectedTemplateId = null;
            let selectedTemplateDuration = 14;
            
            // Set sprint ID from backend  
            window.currentSprintId = /*[[${currentSprintId}]]*/ null;
            
            // Arrays to store holidays, deployments, and code freezes
            let sprintHolidays = [];
            let sprintDeployments = [];
            let sprintCodeFreezes = [];
            let globalHolidays = []; // Pre-configured global holidays
            let selectedGlobalHolidayIds = new Set(); // Track which global holidays are selected
            
            // REAL API Functions
            function calculateEndDate() {
                const startDate = document.getElementById('startDate').value;
                const duration = parseInt(document.getElementById('duration').value);
                
                if (startDate && duration) {
                    // Call real API to calculate working days
                    fetch('/api/sprint-setup/calculate-dates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            startDate: startDate,
                            duration: duration
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('endDate').value = data.data.endDate;
                            // ‚úÖ Don't auto-populate freeze date - user decides if needed
                            updateTimeline();
                            updateDateRestrictions(); // ‚úÖ Restrict date pickers to sprint range
                            // ‚úÖ Fetch global holidays for this date range
                            loadGlobalHolidays(startDate, data.data.endDate);
                            console.log('Working days calculated:', data.data.workingDays);
                        } else {
                            console.error('Error calculating dates:', data.message);
                            // Fallback to simple calculation
                            fallbackCalculateEndDate(startDate, duration);
                        }
                    })
                    .catch(error => {
                        console.error('API error:', error);
                        // Fallback to simple calculation
                        fallbackCalculateEndDate(startDate, duration);
                    });
                }
            }
            
            function fallbackCalculateEndDate(startDate, duration) {
                const start = new Date(startDate);
                const end = new Date(start);
                end.setDate(start.getDate() + duration);
                
                const endDateStr = end.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDateStr;
                // ‚úÖ Don't auto-populate freeze date - user decides if needed
                
                updateTimeline();
                updateDateRestrictions(); // ‚úÖ Restrict date pickers to sprint range
                // ‚úÖ Fetch global holidays for this date range
                loadGlobalHolidays(startDate, endDateStr);
            }
            
            /**
             * Load global/pre-configured holidays for the given date range
             * These holidays are ALWAYS included in the sprint
             */
            async function loadGlobalHolidays(startDate, endDate) {
                try {
                    const response = await fetch(`/api/sprint-setup/holidays?startDate=${startDate}&endDate=${endDate}`);
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.length > 0) {
                        globalHolidays = data.data;
                        
                        // ‚úÖ Auto-select ALL global holidays (they are mandatory)
                        selectedGlobalHolidayIds.clear();
                        globalHolidays.forEach(holiday => {
                            selectedGlobalHolidayIds.add(holiday.id);
                        });
                        
                        // Show the global holidays section
                        document.getElementById('globalHolidaysSection').classList.remove('hidden');
                        renderGlobalHolidays();
                        updateTimeline(); // ‚úÖ Update timeline immediately after loading
                        console.log('‚úÖ Loaded', globalHolidays.length, 'global holidays (auto-included)');
                    } else {
                        // Hide the section if no global holidays
                        document.getElementById('globalHolidaysSection').classList.add('hidden');
                        globalHolidays = [];
                        selectedGlobalHolidayIds.clear();
                        updateTimeline(); // ‚úÖ Update timeline even when no holidays
                        console.log('No global holidays found for this date range');
                    }
                } catch (error) {
                    console.error('Error loading global holidays:', error);
                    document.getElementById('globalHolidaysSection').classList.add('hidden');
                }
            }
            
            /**
             * Render global holidays (always included, no checkboxes)
             */
            function renderGlobalHolidays() {
                const container = document.getElementById('globalHolidaysList');
                if (globalHolidays.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">No global holidays in this sprint period</p>';
                    return;
                }
                
                container.innerHTML = globalHolidays.map(holiday => {
                    // ‚úÖ Enhanced date parsing - handle multiple formats
                    // Backend returns 'holidayDate' field (not 'date')
                    const dateValue = holiday.holidayDate || holiday.date;
                    let dateStr = 'Invalid Date';
                    
                    try {
                        if (Array.isArray(dateValue)) {
                            // Handle array format [2024, 12, 25] from backend
                            const [year, month, day] = dateValue;
                            const dateObj = new Date(year, month - 1, day);
                            dateStr = dateObj.toLocaleDateString('en-US', { 
                                month: 'short', day: 'numeric', year: 'numeric' 
                            });
                        } else if (typeof dateValue === 'string') {
                            // Handle string formats
                            if (dateValue.includes('-')) {
                                // Format: "2024-12-25"
                                const parts = dateValue.split('-');
                                if (parts.length === 3) {
                                    const dateObj = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                                    dateStr = dateObj.toLocaleDateString('en-US', { 
                                        month: 'short', day: 'numeric', year: 'numeric' 
                                    });
                                }
                            } else if (dateValue.includes('/')) {
                                // Format: "12/25/2024"
                                const dateObj = new Date(dateValue);
                                dateStr = dateObj.toLocaleDateString('en-US', { 
                                    month: 'short', day: 'numeric', year: 'numeric' 
                                });
                            } else {
                                // Try generic parse
                                const dateObj = new Date(dateValue);
                                if (!isNaN(dateObj.getTime())) {
                                    dateStr = dateObj.toLocaleDateString('en-US', { 
                                        month: 'short', day: 'numeric', year: 'numeric' 
                                    });
                                }
                            }
                        } else if (typeof dateValue === 'object' && dateValue !== null) {
                            // Handle date object
                            const dateObj = new Date(dateValue);
                            if (!isNaN(dateObj.getTime())) {
                                dateStr = dateObj.toLocaleDateString('en-US', { 
                                    month: 'short', day: 'numeric', year: 'numeric' 
                                });
                            }
                        }
                        
                        console.log('Holiday date parsing:', holiday.name, 'Raw:', dateValue, 'Parsed:', dateStr);
                    } catch (error) {
                        console.error('Error parsing holiday date:', holiday, error);
                        dateStr = 'Invalid Date';
                    }
                    
                    return `
                    <div class="flex items-center gap-3 p-3 rounded-lg bg-yellow-50 border border-yellow-200/80">
                        <div class="flex-shrink-0">
                            <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800 text-sm">${holiday.name}</p>
                            <p class="text-xs text-gray-500">${dateStr}</p>
                        </div>
                        <span class="text-xs bg-yellow-600 text-white px-2.5 py-1 rounded-full font-medium">Auto-included</span>
                    </div>
                    `;
                }).join('');
            }
            
            /**
             * Note: Global holidays are now always included (no toggle needed)
             * This function is kept for compatibility but does nothing
             */
            function toggleGlobalHoliday(holidayId) {
                // Global holidays are mandatory - no action needed
                console.log('Global holidays are always included');
            }
            
            /**
             * Get all holidays for display (global + custom)
             * Used for timeline and calculations
             */
            function getAllHolidaysForDisplay() {
                const allHolidays = [];
                
                // Add selected global holidays (using holidayDate field from backend)
                globalHolidays.forEach(holiday => {
                    if (selectedGlobalHolidayIds.has(holiday.id)) {
                        allHolidays.push({
                            id: holiday.id,
                            date: holiday.holidayDate || holiday.date,
                            name: holiday.name,
                            isGlobal: true // ‚úÖ Mark as global
                        });
                    }
                });
                
                // Add custom holidays
                sprintHolidays.forEach(holiday => {
                    allHolidays.push({
                        ...holiday,
                        isGlobal: false // ‚úÖ Mark as custom
                    });
                });
                
                return allHolidays;
            }
            
            /**
             * Get ONLY custom holidays for saving to sprint_event table
             * Global holidays are NOT saved (already in holiday table)
             */
            function getCustomHolidaysForSaving() {
                // ‚úÖ Return only custom holidays (not global ones)
                return sprintHolidays;
            }
            
            /**
             * Restrict all date pickers to the sprint date range
             * Prevents users from selecting dates outside the sprint boundaries
             */
            function updateDateRestrictions() {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    console.log('‚ö†Ô∏è Cannot set date restrictions: start or end date not available');
                    return;
                }
                
                // List of all date input fields that should be restricted to sprint range
                const restrictedDateFields = [
                    'planningDate',        // Sprint Planning meeting
                    'groomingDate',        // Backlog Grooming meeting
                    'retrospectiveDate',   // Sprint Retrospective meeting
                    'newHolidayDate',      // Holiday date picker
                    'newDeploymentDate',   // Deployment date picker
                    'newCodeFreezeDate'    // Code Freeze date picker
                ];
                
                // Apply min/max restrictions to each field
                restrictedDateFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.setAttribute('min', startDate);
                        field.setAttribute('max', endDate);
                        
                        // If current value is outside range, clear it
                        const currentValue = field.value;
                        if (currentValue && (currentValue < startDate || currentValue > endDate)) {
                            field.value = '';
                            console.log(`‚ö†Ô∏è Cleared ${fieldId} - date was outside sprint range`);
                        }
                    }
                });
                
                console.log(`‚úÖ Date restrictions applied: ${startDate} to ${endDate}`);
            }
            
            function updateTimeline() {
                const startDateStr = document.getElementById('startDate').value;
                const endDateStr = document.getElementById('endDate').value;
                
                if (!startDateStr) {
                    return; // Can't build timeline without start date
                }
                
                const startDate = new Date(startDateStr);
                const endDate = endDateStr ? new Date(endDateStr) : null;
                
                // Collect ALL timeline events with dates
                const allEvents = [];
                
                // 1. Sprint Start
                allEvents.push({
                    date: new Date(startDate),
                    time: null,
                    sortOrder: 0,
                    type: 'sprint-start',
                    title: 'Sprint Start',
                    icon: 'sprint-start',
                    iconColor: 'text-green-500',
                    dotColor: 'border-primary-500 bg-primary-500'
                });
                
                // 2. Planning Meeting (only if date is set)
                const planningDateStr = document.getElementById('planningDate').value;
                const planningTimeStr = document.getElementById('planningTime').value;
                if (planningDateStr) {
                    allEvents.push({
                        date: new Date(planningDateStr),
                        time: planningTimeStr || '10:00',
                        sortOrder: 1,
                        type: 'meeting',
                        title: 'Meeting: Planning',
                        icon: 'users',
                        iconColor: 'text-blue-500',
                        dotColor: 'border-primary-500 bg-primary-500'
                    });
                }
                
                // 3. Grooming Meeting (only if date is set)
                const groomingDateStr = document.getElementById('groomingDate').value;
                const groomingTimeStr = document.getElementById('groomingTime').value;
                if (groomingDateStr) {
                    allEvents.push({
                        date: new Date(groomingDateStr),
                        time: groomingTimeStr || '14:00',
                        sortOrder: 2,
                        type: 'meeting',
                        title: 'Meeting: Grooming',
                        icon: 'users',
                        iconColor: 'text-blue-500',
                        dotColor: 'border-primary-500 bg-primary-500'
                    });
                }
                
                // 4. Retrospective Meeting (only if date is set)
                const retrospectiveDateStr = document.getElementById('retrospectiveDate').value;
                const retrospectiveTimeStr = document.getElementById('retrospectiveTime').value;
                if (retrospectiveDateStr) {
                    allEvents.push({
                        date: new Date(retrospectiveDateStr),
                        time: retrospectiveTimeStr || '15:00',
                        sortOrder: 8,
                        type: 'meeting',
                        title: 'Meeting: Retrospective',
                        icon: 'users',
                        iconColor: 'text-blue-500',
                        dotColor: 'border-primary-500 bg-primary-500'
                    });
                }
                
                // 5. Add code freeze dates
                sprintCodeFreezes.forEach(codeFreeze => {
                    allEvents.push({
                        date: new Date(codeFreeze.date),
                        time: null,
                        sortOrder: 3,
                        type: 'freeze',
                        title: 'üîí Code Freeze' + (codeFreeze.name ? ': ' + codeFreeze.name : ''),
                        icon: 'lock',
                        iconColor: 'text-orange-500',
                        dotColor: 'border-orange-500 bg-orange-500'
                    });
                });
                
                // 6. Add holidays (both global and custom for display)
                const allHolidays = getAllHolidaysForDisplay();
                allHolidays.forEach(holiday => {
                    // Parse date properly - could be string, array, or object
                    let holidayDate;
                    const dateValue = holiday.date;
                    
                    if (Array.isArray(dateValue)) {
                        const [year, month, day] = dateValue;
                        holidayDate = new Date(year, month - 1, day);
                    } else if (typeof dateValue === 'string') {
                        if (dateValue.includes('-')) {
                            const parts = dateValue.split('-');
                            holidayDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                        } else {
                            holidayDate = new Date(dateValue);
                        }
                    } else {
                        holidayDate = new Date(dateValue);
                    }
                    
                    allEvents.push({
                        date: holidayDate,
                        time: null,
                        sortOrder: 6,
                        type: 'holiday',
                        title: 'üèñÔ∏è Holiday: ' + holiday.name,
                        icon: 'sun',
                        iconColor: 'text-yellow-500',
                        dotColor: 'border-yellow-500 bg-yellow-500'
                    });
                });
                
                // 7. Add deployments
                sprintDeployments.forEach(deployment => {
                    allEvents.push({
                        date: new Date(deployment.date),
                        time: null,
                        sortOrder: 5,
                        type: 'deployment',
                        title: 'üöÄ Deployment: ' + deployment.name,
                        icon: 'rocket',
                        iconColor: 'text-green-500',
                        dotColor: 'border-green-500 bg-green-500'
                    });
                });
                
                // 8. Sprint End (if set)
                if (endDate) {
                    allEvents.push({
                        date: new Date(endDate),
                        time: null,
                        sortOrder: 7,
                        type: 'sprint-end',
                        title: 'Sprint End',
                        icon: 'sprint-end',
                        iconColor: 'text-red-500',
                        dotColor: 'border-primary-500 bg-primary-500'
                    });
                }
                
                // Sort events chronologically (by date first, then by sortOrder for same-day events)
                allEvents.sort((a, b) => {
                    const dateCompare = a.date.getTime() - b.date.getTime();
                    if (dateCompare !== 0) return dateCompare;
                    return a.sortOrder - b.sortOrder;
                });
                
                // Render timeline
                renderTimeline(allEvents);
            }
            
            function renderTimeline(events) {
                const container = document.getElementById('timelineContainer');
                if (!container) return;
                
                container.innerHTML = '';
                
                events.forEach((event, index) => {
                    const dateStr = event.date.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    
                    const timeStr = event.time ? ` at ${event.time}` : '';
                    
                    // Determine if this is a major milestone (Sprint Start or End)
                    const isMajorMilestone = event.type === 'sprint-start' || event.type === 'sprint-end';
                    
                    // Choose appropriate SVG icon - Enhanced & Attractive
                    let svgIcon = '';
                    if (event.icon === 'sprint-start') {
                        // Rocket launching - exciting start!
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>';
                    } else if (event.icon === 'sprint-end') {
                        // Flag at finish line
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>';
                    } else if (event.icon === 'users') {
                        // Team meeting icon
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>';
                    } else if (event.icon === 'lock') {
                        // Code freeze lock
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>';
                    } else if (event.icon === 'rocket') {
                        // Deployment rocket
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>';
                    } else if (event.icon === 'sun') {
                        // Holiday sun icon
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
                    } else {
                        // Default calendar icon
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>';
                    }
                    
                    // Different styling for major milestones vs regular events
                    let eventHtml = '';
                    if (isMajorMilestone) {
                        // Major Milestone: Sprint Start or Sprint End
                        const milestoneColor = event.type === 'sprint-start' ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-green-200' : 'bg-gradient-to-r from-red-50 to-rose-50 border-red-200';
                        const badgeColor = event.type === 'sprint-start' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const iconSize = 'w-6 h-6';
                        const dotSize = 'h-7 w-7';
                        const innerDotSize = 'h-3 w-3';
                        
                        eventHtml = `
                            <div class="relative flex items-start space-x-4 ${milestoneColor} border-2 rounded-xl p-4 shadow-sm mb-2">
                                <div class="absolute left-[-30px] top-5 bg-white ${dotSize} rounded-full border-3 ${event.dotColor} flex items-center justify-center shadow-md">
                                    <div class="${innerDotSize} ${event.dotColor.replace('border-', 'bg-').split(' ')[0]} rounded-full"></div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${badgeColor} uppercase tracking-wide">
                                            ${event.type === 'sprint-start' ? 'üöÄ Milestone' : 'üèÅ Milestone'}
                                        </span>
                                    </div>
                                    <p class="text-xl font-extrabold text-gray-900 mb-1">${event.title}</p>
                                    <p class="text-base text-gray-600 flex items-center space-x-2">
                                        <svg class="${iconSize} ${event.iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            ${svgIcon}
                                        </svg>
                                        <span class="font-semibold">${dateStr}${timeStr}</span>
                                    </p>
                                </div>
                            </div>
                        `;
                    } else {
                        // Regular Event: Meetings, Deployments, Holidays, etc.
                        eventHtml = `
                            <div class="relative flex items-start space-x-4 ml-4">
                                <div class="absolute left-[-30px] top-0.5 bg-white h-5 w-5 rounded-full border-2 ${event.dotColor} flex items-center justify-center">
                                    <div class="h-2 w-2 ${event.dotColor.replace('border-', 'bg-').split(' ')[0]} rounded-full"></div>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">${event.title}</p>
                                    <p class="text-sm text-gray-500 flex items-center space-x-1.5">
                                        <svg class="w-4 h-4 ${event.iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            ${svgIcon}
                                        </svg>
                                        <span>${dateStr}${timeStr}</span>
                                    </p>
                                </div>
                            </div>
                        `;
                    }
                    
                    container.insertAdjacentHTML('beforeend', eventHtml);
                });
            }
            
            function saveSprintSettings() {
                const startDate = document.getElementById('startDate').value;
                const duration = parseInt(document.getElementById('duration').value);
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !duration) {
                    showError('Please fill in start date and duration first');
                    return;
                }
                
                // Get current sprint ID - if none exists, create a new sprint first
                const sprintId = getCurrentSprintId();
                
                if (!sprintId) {
                    // No active sprint - create new sprint first, then save configuration
                    createNewSprintAndSaveSettings(startDate, duration);
                } else {
                    // Active sprint exists - update configuration
                    updateSprintConfiguration(sprintId, startDate, duration);
                }
            }
            
            function createNewSprintAndSaveSettings(startDate, duration) {
                // Create new sprint first
                fetch('/api/sprints/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        startDate: startDate,
                        duration: duration,
                        status: 'ACTIVE'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const newSprintId = data.data.id;
                        console.log('‚úÖ New sprint created:', newSprintId);
                        
                        // Update the page context
                        window.currentSprintId = newSprintId;
                        
                        // Now save the detailed configuration
                        updateSprintConfiguration(newSprintId, startDate, duration);
                    } else {
                        showError('Error creating new sprint: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error creating sprint:', error);
                    showError('Failed to create new sprint');
                });
            }
            
            function updateSprintConfiguration(sprintId, startDate, duration) {
                // Collect all meeting data
                const meetings = {
                    planning: {
                        date: document.getElementById('planningDate').value,
                        time: document.getElementById('planningTime').value,
                        duration: parseInt(document.getElementById('planningDuration').value)
                    },
                    grooming: {
                        date: document.getElementById('groomingDate').value,
                        time: document.getElementById('groomingTime').value,
                        duration: parseInt(document.getElementById('groomingDuration').value)
                    },
                    retrospective: {
                        date: document.getElementById('retrospectiveDate').value,
                        time: document.getElementById('retrospectiveTime').value,
                        duration: parseInt(document.getElementById('retrospectiveDuration').value)
                    }
                };
                
                // Save complete sprint configuration including holidays, deployments, code freezes, and meetings in one API call
                fetch(`/api/sprint-setup/${sprintId}/configuration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        startDate: startDate,
                        duration: duration,
                        holidays: getCustomHolidaysForSaving(), // ‚úÖ Save ONLY custom holidays (not global)
                        deployments: sprintDeployments,
                        codeFreezes: sprintCodeFreezes,
                        meetings: meetings
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccess('Sprint configuration saved successfully!');
                        
                        // Reload sprint data to show updated state (stay on same page)
                        setTimeout(() => {
                            loadSprintData();
                        }, 500);
                        
                    } else {
                        showError('Error saving sprint settings: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('Failed to save sprint settings');
                });
            }
            
            // Global variable to store current invite data for Outlook
            let currentInviteData = null;
            
            function generateInvite(meetingType) {
                // Check if meeting has date/time before generating invite
                const date = document.getElementById(meetingType + 'Date').value;
                const time = document.getElementById(meetingType + 'Time').value;
                
                if (!date || !time) {
                    showWarning('Please set meeting date and time first, then click Save to persist it.');
                    return;
                }
                
                // Generate AI invite (meeting should already be saved via configuration endpoint)
                openInviteModal(meetingType);
                generateAIInvite(meetingType);
            }
            
            function openInviteModal(meetingType) {
                // Set meeting type label
                const labels = {
                    'planning': 'Sprint Planning Meeting',
                    'grooming': 'Backlog Grooming Meeting',
                    'retrospective': 'Sprint Retrospective Meeting'
                };
                document.getElementById('inviteMeetingType').textContent = labels[meetingType] || 'Sprint Meeting';
                
                // Show modal with loading state
                document.getElementById('inviteModal').classList.remove('hidden');
                document.getElementById('inviteLoading').classList.remove('hidden');
                document.getElementById('inviteContent').classList.add('hidden');
            }
            
            function closeInviteModal() {
                document.getElementById('inviteModal').classList.add('hidden');
                currentInviteData = null;
            }
            
            async function generateAIInvite(meetingType) {
                const sprintId = getCurrentSprintId();
                if (!sprintId) {
                    showError('No active sprint found');
                    closeInviteModal();
                    return;
                }
                
                try {
                    const response = await fetch(`/api/sprint-setup/${sprintId}/meetings/${meetingType}/generate-invite`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        // Store invite data for Outlook
                        currentInviteData = data.data;
                        
                        // Populate modal fields
                        document.getElementById('inviteSubject').value = data.data.subject || 'Sprint Meeting';
                        document.getElementById('inviteDate').value = formatDate(data.data.date);
                        document.getElementById('inviteTime').value = formatTime(data.data.time);
                        document.getElementById('inviteDuration').value = data.data.duration + ' min';
                        
                        // Store body in hidden textarea and display in formatted div
                        const bodyContent = data.data.body || data.data.rawInvite;
                        document.getElementById('inviteBody').value = bodyContent;
                        document.getElementById('inviteBodyDisplay').textContent = bodyContent;
                        
                        // Show content, hide loading
                        document.getElementById('inviteLoading').classList.add('hidden');
                        document.getElementById('inviteContent').classList.remove('hidden');
                        
                        showSuccess('AI invite generated successfully!');
                    } else {
                        showError(data.message || 'Failed to generate AI invite');
                        closeInviteModal();
                    }
                } catch (error) {
                    console.error('Error generating AI invite:', error);
                    showError('Error generating AI invite');
                    closeInviteModal();
                }
            }
            
            function copyInviteToClipboard() {
                const subject = document.getElementById('inviteSubject').value;
                const body = document.getElementById('inviteBody').value;
                const fullText = `Subject: ${subject}\n\n${body}`;
                
                navigator.clipboard.writeText(fullText).then(() => {
                    showSuccess('Invite copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    showError('Failed to copy invite');
                });
            }
            
            function openInOutlook() {
                if (!currentInviteData) {
                    showError('No invite data available');
                    return;
                }
                
                // Convert date and time to ISO format for Outlook
                const date = currentInviteData.date;
                const time = currentInviteData.time || '10:00:00';
                const duration = parseInt(currentInviteData.duration) || 60;
                
                // Create start and end times
                const startDateTime = new Date(`${date}T${time}`);
                const endDateTime = new Date(startDateTime.getTime() + duration * 60000);
                
                // Format dates for Outlook (ISO 8601)
                const startISO = startDateTime.toISOString();
                const endISO = endDateTime.toISOString();
                
                // Get subject
                const subject = encodeURIComponent(currentInviteData.subject || 'Sprint Meeting');
                
                // Format body for Outlook - convert to HTML for better formatting
                let bodyText = currentInviteData.body || currentInviteData.rawInvite;
                
                // Convert plain text to HTML for Outlook
                const bodyHTML = convertTextToHTML(bodyText);
                const body = encodeURIComponent(bodyHTML);
                
                // Create Outlook Web URL
                const outlookUrl = `https://outlook.office.com/calendar/0/deeplink/compose?`
                    + `subject=${subject}`
                    + `&body=${body}`
                    + `&startdt=${startISO}`
                    + `&enddt=${endISO}`
                    + `&path=/calendar/action/compose`;
                
                // Open in new window
                window.open(outlookUrl, '_blank');
                
                showSuccess('Opening in Outlook...');
            }
            
            function convertTextToHTML(text) {
                if (!text) return '';
                
                // Split into lines
                const lines = text.split('\n');
                let html = '<div style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000;">';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line === '') {
                        // Empty line = line break
                        html += '<br>';
                    } else if (line.endsWith(':')) {
                        // Section headers (AGENDA:, MEETING DETAILS:, etc.)
                        html += `<p style="margin: 12px 0 6px 0; font-weight: bold; font-size: 12pt; color: #1a73e8;">${escapeHtml(line)}</p>`;
                    } else if (line.match(/^\d+\./)) {
                        // Numbered list items
                        html += `<p style="margin: 4px 0 4px 20px;">${escapeHtml(line)}</p>`;
                    } else if (line.startsWith('Date:') || line.startsWith('Time:') || line.startsWith('Duration:')) {
                        // Meeting detail lines
                        html += `<p style="margin: 4px 0 4px 20px; color: #5f6368;">${escapeHtml(line)}</p>`;
                    } else {
                        // Regular paragraph
                        html += `<p style="margin: 8px 0;">${escapeHtml(line)}</p>`;
                    }
                }
                
                html += '</div>';
                return html;
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Helper functions for date/time formatting
            function formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
            
            function formatTime(timeStr) {
                if (!timeStr) return '';
                // Handle both "HH:MM:SS" and "HH:MM" formats
                const parts = timeStr.split(':');
                const hours = parseInt(parts[0]);
                const minutes = parts[1];
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                return `${displayHours}:${minutes} ${ampm}`;
            }
            
            // Meeting data is now saved via the /configuration endpoint
            // No separate saveMeetingData function needed
            
            // Holiday Management Functions
            function addHoliday() {
                const dateInput = document.getElementById('newHolidayDate');
                const nameInput = document.getElementById('newHolidayName');
                
                const date = dateInput.value;
                const name = nameInput.value.trim();
                
                if (!date || !name) {
                    showError('Please enter both holiday date and name');
                    return;
                }
                
                const holiday = {
                    id: 'holiday-' + Date.now(),
                    date: date,
                    name: name
                };
                
                sprintHolidays.push(holiday);
                dateInput.value = '';
                nameInput.value = '';
                renderHolidays();
                updateTimeline();
                console.log('‚úÖ Holiday added:', holiday);
            }
            
            function removeHoliday(holidayId) {
                sprintHolidays = sprintHolidays.filter(h => h.id !== holidayId);
                renderHolidays();
                updateTimeline();
            }
            
            function renderHolidays() {
                const container = document.getElementById('holidaysList');
                console.log('üé® Rendering custom holidays:', sprintHolidays.length);
                if (sprintHolidays.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No custom holidays added</p>';
                    return;
                }
                container.innerHTML = sprintHolidays.map(holiday => `
                    <div class="flex items-center justify-between p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-800">${holiday.name}</p>
                            <p class="text-xs text-gray-500">${new Date(holiday.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                        </div>
                        <button onclick="removeHoliday('${holiday.id}')" class="text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `).join('');
            }
            
            // Deployment Management Functions
            function addDeployment() {
                const dateInput = document.getElementById('newDeploymentDate');
                const nameInput = document.getElementById('newDeploymentName');
                
                const date = dateInput.value;
                const name = nameInput.value.trim();
                
                if (!date || !name) {
                    showError('Please enter both deployment date and name');
                    return;
                }
                
                const deployment = {
                    id: 'deployment-' + Date.now(),
                    date: date,
                    name: name
                };
                
                sprintDeployments.push(deployment);
                dateInput.value = '';
                nameInput.value = '';
                renderDeployments();
                updateTimeline();
                console.log('‚úÖ Deployment added:', deployment);
            }
            
            function removeDeployment(deploymentId) {
                sprintDeployments = sprintDeployments.filter(d => d.id !== deploymentId);
                renderDeployments();
                updateTimeline();
            }
            
            // Code Freeze Management Functions
            function addCodeFreeze() {
                const dateInput = document.getElementById('newCodeFreezeDate');
                const nameInput = document.getElementById('newCodeFreezeName');
                
                const date = dateInput.value;
                const name = nameInput.value.trim();
                
                if (!date) {
                    showError('Please enter a code freeze date');
                    return;
                }
                
                const codeFreeze = {
                    id: 'freeze-' + Date.now(),
                    date: date,
                    name: name || 'Code Freeze'
                };
                
                sprintCodeFreezes.push(codeFreeze);
                dateInput.value = '';
                nameInput.value = '';
                renderCodeFreezes();
                updateTimeline();
                console.log('‚úÖ Code freeze added:', codeFreeze);
            }
            
            function removeCodeFreeze(freezeId) {
                sprintCodeFreezes = sprintCodeFreezes.filter(f => f.id !== freezeId);
                renderCodeFreezes();
                updateTimeline();
            }
            
            function renderCodeFreezes() {
                const container = document.getElementById('codeFreezeList');
                if (sprintCodeFreezes.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No code freeze dates added</p>';
                    return;
                }
                
                container.innerHTML = sprintCodeFreezes
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(freeze => `
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg border border-orange-200 shadow-sm">
                        <div>
                            <p class="font-semibold text-gray-800">${freeze.name}</p>
                            <p class="text-xs text-gray-500">${new Date(freeze.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                        </div>
                        <button onclick="removeCodeFreeze('${freeze.id}')" class="text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `).join('');
            }
            
            function renderDeployments() {
                const container = document.getElementById('deploymentsList');
                if (sprintDeployments.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No deployments scheduled</p>';
                    return;
                }
                container.innerHTML = sprintDeployments.map(deployment => `
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-800">${deployment.name}</p>
                                <p class="text-xs text-gray-500">${new Date(deployment.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                            </div>
                            <button onclick="removeDeployment('${deployment.id}')" class="text-red-500 hover:text-red-700">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            // NEW Sprint Management Functions - MINIMAL
            function startConfiguredSprint() {
                const startDate = document.getElementById('startDate').value;
                const duration = parseInt(document.getElementById('duration').value);
                
                if (!startDate || !duration) {
                    showError('Please configure sprint start date and duration first');
                    return;
                }
                
                if (confirm('Start sprint with current configuration?')) {
                    fetch('/api/sprints/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            startDate: startDate,
                            duration: duration,
                            status: 'ACTIVE'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess('Sprint started successfully!');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            showError('Error: ' + data.message);
                        }
                    });
                }
            }
            
            function showTemplateSelector() {
                document.getElementById('templateModal').classList.remove('hidden');
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('templateStartDate').value = today;
            }
            
            function closeTemplateModal(event) {
                if (!event || event.target === event.currentTarget) {
                    document.getElementById('templateModal').classList.add('hidden');
                    selectedTemplateId = null;
                    document.getElementById('applyTemplateBtn').disabled = true;
                }
            }
            
            function selectTemplate(templateId, duration) {
                selectedTemplateId = templateId;
                selectedTemplateDuration = duration;
                document.getElementById('applyTemplateBtn').disabled = false;
                
                // Highlight selected
                document.querySelectorAll('#templateModal .cursor-pointer').forEach(el => {
                    el.classList.remove('border-primary-500', 'bg-primary-100');
                    el.classList.add('border-gray-200');
                });
                event.target.closest('.cursor-pointer').classList.add('border-primary-500', 'bg-primary-100');
            }
            
            function applySelectedTemplate() {
                if (!selectedTemplateId) return;
                
                const startDate = document.getElementById('templateStartDate').value;
                if (!startDate) {
                    showError('Please select start date');
                    return;
                }
                
                // Apply template to form
                document.getElementById('startDate').value = startDate;
                document.getElementById('duration').value = selectedTemplateDuration;
                calculateEndDate();
                
                closeTemplateModal();
                showSuccess('Template applied! Configure and start when ready.');
            }
            
            function viewCurrentSprint(sprintId) {
                if (sprintId) window.location.href = '/sprint/' + sprintId;
            }
            
            function completeSprint(sprintId) {
                if (sprintId && confirm('Complete current sprint?')) {
                    fetch('/api/sprints/' + sprintId + '/complete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess('Sprint completed successfully!');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            showError('Error: ' + data.message);
                        }
                    });
                }
            }
            
            // Helper Functions
            function getCurrentSprintId() {
                // Get from URL parameter or active sprint API
                const urlParams = new URLSearchParams(window.location.search);
                const sprintId = urlParams.get('sprintId');
                
                if (sprintId) {
                    return sprintId;
                }
                
                // Try to get current active sprint ID from the page context
                // This should be set by the backend when rendering the page
                const contextSprintId = window.currentSprintId;
                if (contextSprintId && contextSprintId !== 'null') {
                    return contextSprintId;
                }
                
                return null;
            }
            
            function loadTimelineData() {
                const sprintId = getCurrentSprintId();
                if (!sprintId) {
                    console.log('No sprint ID available for timeline');
                    return;
                }
                
                fetch(`/api/sprint-setup/${sprintId}/timeline`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateTimelineWithEvents(data.data);
                        } else {
                            console.error('Error loading timeline:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading timeline:', error);
                    });
            }
            
            // Timeline and meetings are now loaded via loadSprintData() function
            // No separate updateTimelineWithEvents or loadMeetingData needed
            
            function loadSprintData() {
                console.log('üì° Checking for active sprint...');
                
                // Call API to check for active sprint
                fetch('/api/sprints/status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data.hasActiveSprint && data.data.currentSprint) {
                            const sprint = data.data.currentSprint;
                            console.log('‚úÖ Active sprint found:', sprint.id);
                            
                            // Store sprint ID globally
                            window.currentSprintId = sprint.id;
                            
                            // Populate form with sprint data
                            document.getElementById('startDate').value = sprint.startDate;
                            document.getElementById('duration').value = sprint.duration;
                            document.getElementById('endDate').value = sprint.endDate;
                            if (sprint.freezeDate) {
                                document.getElementById('freezeDate').value = sprint.freezeDate;
                            }
                            
                            // Extract holidays, deployments, and meetings from events array
                            if (sprint.events && Array.isArray(sprint.events)) {
                                // Filter holidays from events
                                const holidayEvents = sprint.events.filter(e => e.eventType === 'HOLIDAY');
                                
                                // ‚úÖ Load global holidays FIRST, then separate them from custom ones
                                loadGlobalHolidays(sprint.startDate, sprint.endDate).then(() => {
                                    // After global holidays are loaded, identify which are global vs custom
                                    const globalHolidayIds = new Set(globalHolidays.map(h => h.id));
                                    
                                    // ‚úÖ IMPORTANT: Only custom holidays should be in sprint_event table
                                    // Global holidays come from the holiday table and are NOT saved as sprint events
                                    sprintHolidays = [];
                                    
                                    holidayEvents.forEach(event => {
                                        if (globalHolidayIds.has(event.id)) {
                                            // This shouldn't happen (global holidays shouldn't be saved)
                                            // But if they are, mark them as selected and skip adding to custom
                                            console.warn('‚ö†Ô∏è Found global holiday in sprint events (should not be saved):', event.name);
                                            selectedGlobalHolidayIds.add(event.id);
                                        } else {
                                            // ‚úÖ This is a custom holiday - add to sprintHolidays
                                            sprintHolidays.push({
                                                id: event.id,
                                                date: event.eventDate,
                                                name: event.name
                                            });
                                        }
                                    });
                                    
                                    // ‚úÖ Now render both sections (no duplicates)
                                    renderHolidays();
                                    renderGlobalHolidays();
                                    updateTimeline(); // ‚úÖ Update timeline after holidays are loaded
                                    
                                    console.log('üìÖ Loaded', sprintHolidays.length, 'custom holidays');
                                    console.log('üåç Showing', selectedGlobalHolidayIds.size, 'global holidays (from holiday table)');
                                });
                                
                                // Filter deployments from events
                                const deploymentEvents = sprint.events.filter(e => e.eventType === 'DEPLOYMENT');
                                sprintDeployments = deploymentEvents.map(e => ({
                                    id: e.id,
                                    date: e.eventDate,
                                    name: e.name
                                }));
                                renderDeployments();
                                console.log('üöÄ Loaded', sprintDeployments.length, 'deployments');
                                
                                // Filter code freeze dates from events
                                const codeFreezeEvents = sprint.events.filter(e => e.eventType === 'CODE_FREEZE');
                                sprintCodeFreezes = codeFreezeEvents.map(e => ({
                                    id: e.id,
                                    date: e.eventDate,
                                    name: e.name || 'Code Freeze'
                                }));
                                renderCodeFreezes();
                                console.log('üîí Loaded', sprintCodeFreezes.length, 'code freezes');
                                
                                // Filter meetings from events and populate meeting fields
                                const meetingEvents = sprint.events.filter(e => e.eventType === 'MEETING');
                                meetingEvents.forEach(meeting => {
                                    const meetingType = meeting.eventSubtype ? meeting.eventSubtype.toLowerCase() : null;
                                    if (meetingType && ['planning', 'grooming', 'retrospective'].includes(meetingType)) {
                                        // Populate meeting fields
                                        const dateField = document.getElementById(meetingType + 'Date');
                                        const timeField = document.getElementById(meetingType + 'Time');
                                        const durationField = document.getElementById(meetingType + 'Duration');
                                        
                                        if (dateField && meeting.eventDate) dateField.value = meeting.eventDate;
                                        if (timeField && meeting.eventTime) timeField.value = meeting.eventTime;
                                        if (durationField && meeting.durationMinutes) durationField.value = meeting.durationMinutes;
                                        
                                        console.log(`üìÖ Loaded ${meetingType} meeting: ${meeting.eventDate} ${meeting.eventTime}`);
                                    }
                                });
                            }
                            
                            updateTimeline();
                            updateDateRestrictions(); // ‚úÖ Restrict date pickers when loading existing sprint
                            console.log('üìã Sprint data populated in form');
                        } else {
                            console.log('‚ÑπÔ∏è No active sprint found - showing blank form');
                            window.currentSprintId = null;
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error checking for active sprint:', error);
                        console.log('Starting with blank form');
                        window.currentSprintId = null;
                    });
            }
            
            // Initialize
            document.addEventListener('DOMContentLoaded', function() {
                const today = new Date().toISOString().split('T')[0];
                
                console.log('üöÄ Sprint Setup page loaded');
                console.log('Current Sprint ID from backend:', window.currentSprintId);
                
                // Initialize holiday, deployment, and code freeze lists
                renderHolidays();
                renderDeployments();
                renderCodeFreezes();
                
                // Try to load existing sprint data first
                loadSprintData();
                
                // Set defaults if no sprint data loaded
                setTimeout(() => {
                    if (!document.getElementById('startDate').value) {
                        console.log('Setting default start date:', today);
                        document.getElementById('startDate').value = today;
                        document.getElementById('duration').value = '10'; // Default to 10 days
                        calculateEndDate(); // This should work even without sprint ID
                    }
                    
                    console.log('‚úÖ Sprint Setup initialization complete');
                }, 500);
                
                // Add event listeners to meeting fields to update timeline dynamically
                const meetingFields = [
                    'planningDate', 'planningTime',
                    'groomingDate', 'groomingTime',
                    'retrospectiveDate', 'retrospectiveTime'
                ];
                
                meetingFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('change', function() {
                            console.log(`Meeting field ${fieldId} changed, updating timeline`);
                            updateTimeline();
                        });
                    }
                });
            });
            
            // ===== BEAUTIFUL TOAST NOTIFICATION SYSTEM =====
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                // Define toast styles based on type
                const styles = {
                    success: {
                        bg: 'bg-green-500',
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                              </svg>`,
                        iconBg: 'bg-green-600'
                    },
                    error: {
                        bg: 'bg-red-500',
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                              </svg>`,
                        iconBg: 'bg-red-600'
                    },
                    warning: {
                        bg: 'bg-yellow-500',
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                              </svg>`,
                        iconBg: 'bg-yellow-600'
                    }
                };
                
                const style = styles[type] || styles.success;
                
                // Create toast element
                const toast = document.createElement('div');
                toast.id = toastId;
                toast.className = `${style.bg} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] max-w-md pointer-events-auto transform transition-all duration-300 ease-in-out translate-x-full opacity-0`;
                toast.innerHTML = `
                    <div class="flex items-center gap-3 flex-1">
                        <div class="${style.iconBg} rounded-full p-1 flex-shrink-0">
                            ${style.icon}
                        </div>
                        <p class="text-sm font-medium">${escapeHtmlForToast(message)}</p>
                    </div>
                    <button onclick="removeToast('${toastId}')" class="text-white hover:text-gray-200 transition-colors flex-shrink-0">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                
                toastContainer.appendChild(toast);
                
                // Trigger animation after a small delay to ensure CSS transition works
                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                }, 10);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    removeToast(toastId);
                }, 5000);
            }
            
            function removeToast(toastId) {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }
            }
            
            function showSuccess(message) {
                showToast(message, 'success');
            }
            
            function showError(message) {
                showToast(message, 'error');
            }
            
            function showWarning(message) {
                showToast(message, 'warning');
            }
            
            function escapeHtmlForToast(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        </script>
    </div>
</body>
</html>