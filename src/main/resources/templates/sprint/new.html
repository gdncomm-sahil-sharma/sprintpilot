<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Sprint Setup - SprintPilot</title>
</head>
<body>
    <div th:fragment="content">
        <!-- Toast Container -->
        <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-3 pointer-events-none">
            <!-- Toasts will be dynamically inserted here -->
        </div>
        
        <div class="space-y-6">
            
            <!-- Header Section - Consistent with Dashboard & History -->
            <div class="flex flex-col md:flex-row justify-between md:items-start gap-4 mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Sprint Setup & Configuration</h2>
                    <p class="text-gray-600 mt-2">Configure sprint dates, meetings, and key events for your team</p>
                </div>
                <button id="saveConfigBtn" onclick="saveSprintSettings()" class="px-6 py-3 rounded-xl font-bold text-sm transition-all duration-200 shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-green-300 flex items-center justify-center space-x-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white transform hover:scale-105">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>Save Configuration</span>
                </button>
            </div>

            <!-- No Active Sprint - Create Sprint Landing -->
            <div id="noSprintLanding" class="hidden">
                <div class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 rounded-2xl shadow-xl border border-primary-200/50 p-12 text-center">
                    <div class="mb-8">
                        <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-primary-100 border-4 border-primary-200 mb-6">
                            <svg class="w-12 h-12 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-3">No Active Sprint</h2>
                        <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                            Ready to start planning your next sprint? Create a new sprint to configure dates, meetings, and key events for your team.
                        </p>
                    </div>
                    
                    <div class="flex justify-center gap-4">
                        <button onclick="showCreateSprintForm()" class="px-8 py-4 rounded-xl font-bold text-lg transition-all duration-200 shadow-lg hover:shadow-2xl focus:outline-none focus:ring-4 focus:ring-primary-300 flex items-center justify-center space-x-3 bg-gradient-to-r from-primary-600 to-indigo-600 hover:from-primary-700 hover:to-indigo-700 text-white transform hover:scale-105">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>Create New Sprint</span>
                        </button>
                    </div>
                    
                    <div class="mt-8 pt-8 border-t border-primary-200">
                        <p class="text-sm text-gray-500 mb-4">Or continue with:</p>
                        <div class="flex justify-center gap-4">
                            <a href="/" class="text-primary-600 hover:text-primary-700 font-medium text-sm flex items-center gap-2 hover:underline">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                </svg>
                                Dashboard
                            </a>
                            <a href="/history" class="text-primary-600 hover:text-primary-700 font-medium text-sm flex items-center gap-2 hover:underline">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Sprint History
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sprint Configuration Form -->
            <div id="sprintConfigForm">
            
            <!-- Sprint Name Input (Top of Form) -->
            <div class="bg-white rounded-2xl shadow-lg border-2 border-primary-100 p-6 mb-6">
                <label for="sprintName" class="block text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                    Sprint Name
                    <span class="text-xs text-gray-500 font-normal ml-2">(Leave blank to auto-generate "Sprint YYYY-MM-DD")</span>
                </label>
                <input 
                    type="text" 
                    id="sprintName" 
                    name="sprintName" 
                    placeholder="e.g., Q4 2025 Sprint 1, November Sprint, Release 2.0" 
                    maxlength="100"
                    pattern="^[a-zA-Z0-9\s\-_]+$"
                    class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 hover:border-primary-300 transition-colors"
                    title="Sprint name can only contain letters, numbers, spaces, hyphens, and underscores"
                />
                <p class="text-xs text-gray-600 mt-2">
                    <span class="font-semibold">Max 100 characters.</span> Allowed: letters, numbers, spaces, hyphens, underscores.
                </p>
            </div>

            <!-- Progress Stepper -->
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 mb-6">
                <h4 class="text-sm font-semibold text-gray-700 mb-5 flex items-center gap-2">
                    <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Configuration Progress
                </h4>
                <div class="flex items-center justify-between">
                    <!-- Step 1: Core Configuration -->
                    <div class="flex flex-col items-center flex-1">
                        <div class="relative">
                            <div id="step1Circle" class="w-12 h-12 rounded-full border-2 border-gray-300 bg-white flex items-center justify-center transition-all duration-300">
                                <svg id="step1Icon" class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <p class="text-sm font-semibold text-gray-700">Core Configuration</p>
                            <p id="step1Status" class="text-xs text-gray-500 mt-1">Required</p>
                        </div>
                    </div>

                    <!-- Connector Line 1 -->
                    <div id="connector1" class="flex-1 h-0.5 bg-gray-200 mx-4 -mt-8 transition-all duration-300"></div>

                    <!-- Step 2: Sprint Meetings -->
                    <div class="flex flex-col items-center flex-1">
                        <div class="relative">
                            <div id="step2Circle" class="w-12 h-12 rounded-full border-2 border-gray-300 bg-white flex items-center justify-center transition-all duration-300">
                                <svg id="step2Icon" class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <p class="text-sm font-semibold text-gray-700">Sprint Meetings</p>
                            <p id="step2Status" class="text-xs text-gray-500 mt-1">Optional</p>
                        </div>
                    </div>

                    <!-- Connector Line 2 -->
                    <div id="connector2" class="flex-1 h-0.5 bg-gray-200 mx-4 -mt-8 transition-all duration-300"></div>

                    <!-- Step 3: Sprint Events -->
                    <div class="flex flex-col items-center flex-1">
                        <div class="relative">
                            <div id="step3Circle" class="w-12 h-12 rounded-full border-2 border-gray-300 bg-white flex items-center justify-center transition-all duration-300">
                                <svg id="step3Icon" class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <p class="text-sm font-semibold text-gray-700">Sprint Events</p>
                            <p id="step3Status" class="text-xs text-gray-500 mt-1">Optional</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXACT ORIGINAL LAYOUT -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Left Column - Configuration Cards -->
                <div class="lg:col-span-3 space-y-6">
                    
                    <!-- Enhanced Core Configuration Card - Collapsible -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-200/50 hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                        <div class="bg-gradient-to-r from-primary-50 to-indigo-50 px-6 py-4 border-b border-gray-200/50 cursor-pointer hover:from-primary-100 hover:to-indigo-100 transition-colors" onclick="toggleSection('coreConfigContent')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                        <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        Core Configuration
                                        <span id="coreConfigStatus" class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-md bg-red-100 text-red-600">Required</span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Define sprint timeline and duration</p>
                                </div>
                                <svg id="coreConfigContent-icon" class="w-6 h-6 text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div id="coreConfigContent" class="hidden transition-all duration-300">
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <!-- Sprint Start Date -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-1.5">
                                        <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        Sprint Start Date
                                    </label>
                                    <input type="date" id="startDate" name="startDate" class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 hover:border-primary-300 transition-colors" onchange="calculateEndDate()" />
                                </div>
                                
                                <!-- Sprint Duration -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-1.5">
                                        <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Sprint Duration (working days)
                                    </label>
                                    <input type="number" id="duration" name="duration" value="14" min="1" class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500 hover:border-primary-300 transition-colors" onchange="calculateEndDate()" />
                                </div>
                                
                                <!-- Sprint End Date (Calculated) -->
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-1.5">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Sprint End Date
                                        <span class="ml-auto text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">Auto-calculated</span>
                                    </label>
                                    <input type="date" id="endDate" name="endDate" readonly class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm bg-gradient-to-r from-gray-50 to-gray-100 cursor-not-allowed text-gray-700 font-semibold" />
                                </div>
                            </div>
                        </div>
                        </div> <!-- End coreConfigContent -->
                    </div>

                    <!-- Enhanced Sprint Meetings Card - Collapsible -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-200/50 hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 px-6 py-4 border-b border-gray-200/50 cursor-pointer hover:from-indigo-100 hover:to-purple-100 transition-colors" onclick="toggleSection('sprintMeetingsContent')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                        Sprint Meetings
                                        <span id="sprintMeetingsStatus" class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-md bg-gray-100 text-gray-500">Optional</span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1 flex items-center gap-1.5">
                                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                        </svg>
                                        Schedule key sprint ceremonies and generate AI-powered Outlook invites
                                    </p>
                                </div>
                                <svg id="sprintMeetingsContent-icon" class="w-6 h-6 text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div id="sprintMeetingsContent" class="hidden transition-all duration-300">
                        <div class="p-6">
                        <div class="divide-y divide-gray-100">
                            <!-- Sprint Planning -->
                            <div class="py-4 first:pt-0 last:pb-0">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-gray-800">Sprint Planning</h4>
                                    <button onclick="generateInvite('planning')" class="px-4 py-2 rounded-xl font-semibold text-sm transition-all duration-200 shadow-sm hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center space-x-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white focus:ring-indigo-500 transform hover:scale-105">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                        </svg>
                                        <span>Generate Invite</span>
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <input type="date" id="planningDate" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="time" id="planningTime" value="10:00" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="number" id="planningDuration" value="60" min="30" placeholder="Duration (min)" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                </div>
                            </div>
                            
                            <!-- Backlog Grooming -->
                            <div class="py-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-gray-800">Backlog Grooming/Refinement</h4>
                                    <button onclick="generateInvite('grooming')" class="px-4 py-2 rounded-xl font-semibold text-sm transition-all duration-200 shadow-sm hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center space-x-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white focus:ring-indigo-500 transform hover:scale-105">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                        </svg>
                                        <span>Generate Invite</span>
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <input type="date" id="groomingDate" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="time" id="groomingTime" value="14:00" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="number" id="groomingDuration" value="60" min="30" placeholder="Duration (min)" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                </div>
                            </div>
                            
                            <!-- Sprint Retrospective -->
                            <div class="py-4 last:pb-0">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-gray-800">Sprint Retrospective</h4>
                                    <button onclick="generateInvite('retrospective')" class="px-4 py-2 rounded-xl font-semibold text-sm transition-all duration-200 shadow-sm hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 flex items-center space-x-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white focus:ring-indigo-500 transform hover:scale-105">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                        </svg>
                                        <span>Generate Invite</span>
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <input type="date" id="retrospectiveDate" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="time" id="retrospectiveTime" value="15:00" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                    <input type="number" id="retrospectiveDuration" value="60" min="30" placeholder="Duration (min)" class="border-2 border-gray-200 rounded-xl text-sm p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 hover:border-indigo-300 transition-colors" />
                                </div>
                            </div>
                        </div>
                        </div>
                        </div>
                    </div>

                    <!-- Sprint Events & Key Dates - Collapsible Accordion Section -->
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-200/50 hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200/50 cursor-pointer hover:from-blue-100 hover:to-indigo-100 transition-colors" onclick="toggleSection('sprintEventsContent')">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        Sprint Events & Key Dates
                                        <span id="sprintEventsStatus" class="ml-2 px-2 py-0.5 text-xs font-semibold rounded-md bg-gray-100 text-gray-500">Optional</span>
                                    </h3>
                                    <p class="text-sm text-gray-600 mt-1">Holidays, deployments, and code freeze dates</p>
                                </div>
                                <svg id="sprintEventsContent-icon" class="w-6 h-6 text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div id="sprintEventsContent" class="hidden transition-all duration-300">
                            <div class="p-6 space-y-4">
                                
                    <!-- Enhanced Holiday & Deployment Grid - Accordion Style -->
                    <div class="space-y-3">
                        <!-- HolidayManager - Accordion Item -->
                        <div class="border border-gray-200 rounded-xl overflow-hidden">
                            <div class="bg-gradient-to-r from-yellow-50 to-amber-50 px-6 py-4 cursor-pointer hover:from-yellow-100 hover:to-amber-100 transition-colors" onclick="toggleSection('holidaysAccordion')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                            <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                            </svg>
                                            Sprint Holidays
                                        </h4>
                                        <p class="text-xs text-gray-600 mt-1">Mark non-working days</p>
                                    </div>
                                    <svg id="holidaysAccordion-icon" class="w-5 h-5 text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            <div id="holidaysAccordion" class="hidden transition-all duration-300">
                            <div class="p-6">
                            <!-- Global/Pre-configured Holidays Section -->
                            <div id="globalHolidaysSection" class="mb-6 hidden">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-bold text-gray-700 flex items-center gap-2">
                                        <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                                        </svg>
                                        Pre-configured Holidays
                                    </h4>
                                    <span class="text-xs text-green-700 bg-green-100 px-2 py-1 rounded-full font-medium flex items-center gap-1">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        Always Included
                                    </span>
                                </div>
                                <div id="globalHolidaysList" class="space-y-2 p-3 bg-yellow-50/30 rounded-lg border border-yellow-200/50 max-h-48 overflow-y-auto">
                                    <!-- Global holidays will be added here (always included) -->
                                </div>
                            </div>
                            
                            <!-- Manually Added Holidays Section -->
                            <div class="mb-4">
                                <h4 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                                    <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Custom Holidays
                                </h4>
                            <div id="holidaysList" class="space-y-3 mb-4">
                                <!-- Manually added holidays will be dynamically added here -->
                            </div>
                            </div>
                            
                            <!-- Add Holiday Form -->
                            <div class="space-y-3 p-4 bg-gradient-to-br from-yellow-50/50 to-amber-50/50 rounded-xl border-2 border-dashed border-yellow-300">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Holiday Date</label>
                                    <input type="date" id="newHolidayDate" 
                                           class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 hover:border-yellow-300 transition-colors">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Holiday Name</label>
                                    <input type="text" id="newHolidayName" 
                                           class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 hover:border-yellow-300 transition-colors"
                                           placeholder="e.g., Diwali">
                                </div>
                                <button onclick="addHoliday()" 
                                        class="w-full px-4 py-3 bg-gradient-to-r from-yellow-500 to-amber-500 hover:from-yellow-600 hover:to-amber-600 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transform hover:scale-105">
                                    <span class="flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Add Holiday
                                    </span>
                                </button>
                            </div>
                            </div>
                            </div>
                        </div>
                        
                        <!-- DeploymentManager - Accordion Item -->
                        <div class="border border-gray-200 rounded-xl overflow-hidden">
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-6 py-4 cursor-pointer hover:from-green-100 hover:to-emerald-100 transition-colors" onclick="toggleSection('deploymentsAccordion')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                            </svg>
                                            Deployment Events
                                        </h4>
                                        <p class="text-xs text-gray-600 mt-1">Schedule production releases</p>
                                    </div>
                                    <svg id="deploymentsAccordion-icon" class="w-5 h-5 text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            <div id="deploymentsAccordion" class="hidden transition-all duration-300">
                            <div class="p-6">
                            <div id="deploymentsList" class="space-y-3 mb-4">
                                <!-- Deployments will be dynamically added here -->
                            </div>
                            
                            <!-- Add Deployment Form -->
                            <div class="space-y-3 p-4 bg-gradient-to-br from-green-50/50 to-emerald-50/50 rounded-xl border-2 border-dashed border-green-300">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Deployment Date</label>
                                    <input type="date" id="newDeploymentDate" 
                                           class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 hover:border-green-300 transition-colors">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1.5">Deployment Name</label>
                                    <input type="text" id="newDeploymentName" 
                                           class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 hover:border-green-300 transition-colors"
                                           placeholder="e.g., Production">
                                </div>
                                <button onclick="addDeployment()" 
                                        class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transform hover:scale-105">
                                    <span class="flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Add Deployment
                                    </span>
                                </button>
                            </div>
                            </div>
                            </div>
                        </div>
                    
                        <!-- Code Freeze Dates - Accordion Item -->
                        <div class="border border-gray-200 rounded-xl overflow-hidden">
                            <div class="bg-gradient-to-r from-orange-50 to-amber-50 px-6 py-4 cursor-pointer hover:from-orange-100 hover:to-amber-100 transition-colors" onclick="toggleSection('codeFreezeAccordion')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                            <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                            </svg>
                                            Code Freeze Dates
                                            <span class="ml-2 text-xs font-normal bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">Optional</span>
                                        </h4>
                                        <p class="text-xs text-gray-600 mt-1">Lock code changes before deployments</p>
                                    </div>
                                    <svg id="codeFreezeAccordion-icon" class="w-5 h-5 text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            <div id="codeFreezeAccordion" class="hidden transition-all duration-300">
                        <div class="p-6">
                        <div id="codeFreezeList" class="space-y-3 mb-4">
                            <!-- Code freeze dates will be dynamically added here -->
                        </div>
                        
                        <!-- Add Code Freeze Form -->
                        <div class="space-y-3 p-4 bg-gradient-to-br from-orange-50/50 to-amber-50/50 rounded-xl border-2 border-dashed border-orange-300">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Code Freeze Date</label>
                                <input type="date" id="newCodeFreezeDate" 
                                       class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 hover:border-orange-300 transition-colors">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Description (Optional)</label>
                                <input type="text" id="newCodeFreezeName" 
                                       class="block w-full border-2 border-gray-200 rounded-xl shadow-sm p-3 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 hover:border-orange-300 transition-colors"
                                       placeholder="e.g., Pre-production freeze">
                            </div>
                            <button onclick="addCodeFreeze()" 
                                    class="w-full px-4 py-3 bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 text-white rounded-xl text-sm font-bold transition-all duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transform hover:scale-105">
                                <span class="flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Add Code Freeze
                                </span>
                            </button>
                        </div>
                        </div>
                            </div>
                        </div>
                    
                    </div> <!-- End space-y-3 (accordion items container) -->
                            </div> <!-- End p-6 space-y-4 -->
                        </div> <!-- End sprintEventsContent (hidden) -->
                    </div> <!-- End Sprint Events & Key Dates card -->
                    <!-- End Sprint Events & Key Dates -->

                    <!-- Sprint Actions Section - Collapsible -->
                    <div id="sprintActionsSection" class="hidden">
                        <div class="bg-white rounded-2xl shadow-lg border border-gray-200/50 hover:shadow-xl transition-shadow duration-300 overflow-hidden">
                            <div class="bg-gradient-to-r from-purple-50 to-pink-50 px-6 py-4 border-b border-gray-200/50 cursor-pointer hover:from-purple-100 hover:to-pink-100 transition-colors" onclick="toggleSection('sprintActionsContent')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>
                                            </svg>
                                            Sprint Actions
                                        </h3>
                                        <p class="text-sm text-gray-600 mt-1">Manage and complete current sprint</p>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span id="sprintStatusBadge" class="px-3 py-1.5 rounded-full text-xs font-semibold bg-green-100 text-green-800">
                                            ðŸŸ¢ ACTIVE
                                        </span>
                                        <svg id="sprintActionsContent-icon" class="w-6 h-6 text-gray-500 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div id="sprintActionsContent" class="hidden transition-all duration-300">
                            <div class="p-6">
                            
                        <div class="bg-gradient-to-br from-gray-50 to-blue-50/30 rounded-xl p-6 mb-6 border border-gray-200/50">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div class="bg-white/60 rounded-lg p-4 border border-white/80 shadow-sm">
                                    <p class="text-gray-600 mb-2 font-medium">ðŸ“… Sprint Period</p>
                                    <p class="font-bold text-gray-900 text-lg" id="sprintPeriodDisplay">-</p>
                                </div>
                                <div class="bg-white/60 rounded-lg p-4 border border-white/80 shadow-sm">
                                    <p class="text-gray-600 mb-2 font-medium">â±ï¸ Duration</p>
                                    <p class="font-bold text-gray-900 text-lg" id="sprintDurationDisplay">-</p>
                                </div>
                            </div>
                        </div>
                            
                            <div class="flex items-center justify-end">
                                <button 
                                    id="completeSprintBtn"
                                    onclick="openCompleteSprintModal()"
                                    class="px-8 py-4 rounded-xl font-bold text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 disabled:opacity-50 disabled:cursor-not-allowed disabled:grayscale transition-all duration-200 shadow-lg hover:shadow-2xl transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300 flex items-center space-x-2">
                                    <span>Complete Sprint</span>
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                    </svg>
                                </button>
                            </div>
                            </div>
                            </div> <!-- End sprintActionsContent -->
                        </div>
                    </div>
                    <!-- End Sprint Actions -->
                
                </div>
                <!-- End Left Column -->

                <!-- Right Column - Enhanced Dynamic Timeline -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-lg border border-gray-200/50 hover:shadow-xl transition-shadow duration-300 overflow-hidden sticky top-4">
                        <div class="bg-gradient-to-r from-primary-50 to-blue-50 px-6 py-4 border-b border-gray-200/50">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Sprint Timeline
                            </h3>
                            <p class="text-sm text-gray-600 mt-1">Visual overview of all sprint events</p>
                        </div>
                        <div class="p-6 max-h-[800px] overflow-y-auto custom-scrollbar">
                        <div class="relative pl-6">
                            <div class="absolute left-0 top-0 bottom-0 w-0.5 bg-gradient-to-b from-primary-300 via-primary-200 to-primary-300"></div>
                            <!-- All timeline items will be rendered here dynamically -->
                            <div id="timelineContainer" class="space-y-6"></div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        </div> <!-- End Sprint Config Form -->
        
        <!-- Custom Scrollbar Styling -->
        <style>
            .custom-scrollbar::-webkit-scrollbar {
                width: 8px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: linear-gradient(to bottom, #3b82f6, #6366f1);
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(to bottom, #2563eb, #4f46e5);
            }
        </style>

        <!-- Template Selection Modal - MINIMAL ADDITION -->
        <div id="templateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50" onclick="closeTemplateModal(event)">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-800">Choose Sprint Template</h3>
                    <button onclick="closeTemplateModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="p-4">
                    <div class="space-y-2 max-h-60 overflow-y-auto mb-4">
                        <div th:each="template : ${sprintTemplates}" 
                             th:onclick="'selectTemplate(\'' + ${template.id()} + '\', ' + ${template.duration()} + ')'"
                             class="p-3 border border-gray-200 rounded hover:border-primary-300 hover:bg-primary-50 cursor-pointer transition-colors">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-medium text-gray-800" th:text="${template.startDate()} + ' â†’ ' + ${template.endDate()}"></p>
                                    <p class="text-xs text-gray-500" th:text="${template.duration()} + ' days'"></p>
                                </div>
                                <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Completed</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">New Sprint Start Date</label>
                        <input type="date" id="templateStartDate" class="block w-full border-gray-300 rounded-lg shadow-sm p-2 text-sm focus:ring-primary-500 focus:border-primary-500" />
                    </div>
                    
                    <div class="flex justify-end gap-2">
                        <button onclick="closeTemplateModal()" class="px-3 py-1 border border-gray-300 rounded text-sm text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button id="applyTemplateBtn" onclick="applySelectedTemplate()" class="px-3 py-1 bg-primary-600 text-white text-sm rounded hover:bg-primary-700 disabled:opacity-50" disabled>
                            Apply Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Meeting Invite Modal -->
        <div id="inviteModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-6 border-b bg-gradient-to-r from-primary-50 to-primary-100">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-primary-600 flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">AI-Generated Meeting Invite</h3>
                            <p class="text-sm text-gray-600" id="inviteMeetingType">Sprint Meeting</p>
                        </div>
                    </div>
                    <button onclick="closeInviteModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Body -->
                <div class="flex-1 overflow-y-auto p-6">
                    <!-- Loading State -->
                    <div id="inviteLoading" class="hidden text-center py-12">
                        <svg class="animate-spin h-12 w-12 text-primary-600 mx-auto mb-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-gray-600 font-medium">ðŸ¤– AI is crafting your perfect invite...</p>
                        <p class="text-sm text-gray-500 mt-2">This may take a few seconds</p>
                    </div>
                    
                    <!-- Invite Content -->
                    <div id="inviteContent" class="hidden space-y-6">
                        <!-- Subject -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                                </svg>
                                Subject
                            </label>
                            <input type="text" id="inviteSubject" readonly 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-800 font-medium focus:outline-none focus:ring-2 focus:ring-primary-500" />
                        </div>
                        
                        <!-- Meeting Details -->
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">ðŸ“… Date</label>
                                <input type="text" id="inviteDate" readonly 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm" />
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">â° Time</label>
                                <input type="text" id="inviteTime" readonly 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm" />
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">â±ï¸ Duration</label>
                                <input type="text" id="inviteDuration" readonly 
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 text-sm" />
                            </div>
                        </div>
                        
                        <!-- Body -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                                <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Invite Content
                            </label>
                            <div id="inviteBodyDisplay" 
                                 class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 max-h-96 overflow-y-auto"
                                 style="white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; line-height: 1.6;">
                            </div>
                            <textarea id="inviteBody" class="hidden"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="border-t p-6 bg-gray-50">
                    <div class="flex justify-between items-center">
                        <button onclick="copyInviteToClipboard()" 
                                class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy
                        </button>
                        <div class="flex gap-3">
                            <button onclick="closeInviteModal()" 
                                    class="px-5 py-2.5 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                Close
                            </button>
                            <button onclick="openInOutlook()" 
                                    class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors flex items-center gap-2 shadow-sm">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M7 18h10v-2H7v2zM21 11h-8V9h8v2zm0-6h-8V3h8v2zM3 9a2 2 0 012-2h4a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V9zm2 0h4v10H5V9z"/>
                                </svg>
                                Open in Outlook
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Complete Sprint Confirmation Modal -->
        <div id="completeSprintModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
                <!-- Modal Header -->
                <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                                <span class="text-3xl">âœ…</span>
                            </div>
                            <div class="text-white">
                                <h3 class="text-2xl font-bold">Complete Sprint?</h3>
                                <p class="text-sm text-white/90">Review summary before archiving</p>
                            </div>
                        </div>
                        <button onclick="closeCompleteSprintModal()" class="text-white/80 hover:text-white transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div class="p-6 space-y-6">
                    <!-- Sprint Summary -->
                    <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-5 border border-purple-100">
                        <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            Sprint Summary
                        </h4>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-white/60 p-3 rounded-lg">
                                <p class="text-gray-600 mb-1">Sprint Period</p>
                                <p class="font-bold text-gray-900" id="modalSprintPeriod">-</p>
                            </div>
                            <div class="bg-white/60 p-3 rounded-lg">
                                <p class="text-gray-600 mb-1">Duration</p>
                                <p class="font-bold text-gray-900" id="modalSprintDuration">-</p>
                            </div>
                            <div class="bg-white/60 p-3 rounded-lg">
                                <p class="text-gray-600 mb-1">Total Events</p>
                                <p class="font-bold text-gray-900" id="modalEventCount">-</p>
                            </div>
                            <div class="bg-white/60 p-3 rounded-lg">
                                <p class="text-gray-600 mb-1">Sprint Status</p>
                                <p class="font-bold text-green-600">ACTIVE</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Warning Box -->
                    <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-lg">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <div class="text-sm">
                                <p class="font-bold text-amber-800 mb-2">âš ï¸ This action will:</p>
                                <ul class="space-y-1 text-amber-700">
                                    <li class="flex items-start gap-2">
                                        <span class="font-bold">1.</span>
                                        <span>Archive this sprint and mark all data as read-only</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="font-bold">2.</span>
                                        <span>Automatically create the next sprint (starting next Monday)</span>
                                    </li>
                                    <li class="flex items-start gap-2">
                                        <span class="font-bold">3.</span>
                                        <span>Move all sprint data to history for analytics</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Confirmation -->
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <p class="text-center text-gray-700 font-medium">
                            Are you sure you want to complete and archive this sprint?
                        </p>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="border-t p-6 bg-gray-50 flex justify-between items-center">
                    <button onclick="closeCompleteSprintModal()" 
                            class="px-6 py-3 text-gray-700 bg-white border-2 border-gray-300 rounded-xl hover:bg-gray-50 transition-all font-semibold">
                        Cancel
                    </button>
                    <button onclick="archiveSprintAndCreateNext()" 
                            id="confirmArchiveBtn"
                            class="px-8 py-3 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white rounded-xl font-bold transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
                        </svg>
                        <span>Archive Sprint</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- EXACT ORIGINAL JavaScript with new functionality added -->
        <script>
            let selectedTemplateId = null;
            let selectedTemplateDuration = 14;
            
            // Set sprint ID from backend  
            window.currentSprintId = /*[[${currentSprintId}]]*/ null;
            
            // Arrays to store holidays, deployments, and code freezes
            let sprintHolidays = [];
            let sprintDeployments = [];
            let sprintCodeFreezes = [];
            let globalHolidays = []; // Pre-configured global holidays
            let selectedGlobalHolidayIds = new Set(); // Track which global holidays are selected
            
            // Collapsible Section Toggle Function
            function toggleSection(sectionId) {
                const content = document.getElementById(sectionId);
                const icon = document.getElementById(sectionId + '-icon');
                
                if (content.classList.contains('hidden')) {
                    // Expand
                    content.classList.remove('hidden');
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    // Collapse
                    content.classList.add('hidden');
                    icon.style.transform = 'rotate(0deg)';
                }
            }
            
            // Show/hide landing page vs config form
            function showNoSprintLanding() {
                document.getElementById('noSprintLanding').classList.remove('hidden');
                document.getElementById('sprintConfigForm').classList.add('hidden');
                document.getElementById('saveConfigBtn').classList.add('hidden'); // Hide save button
            }
            
            function showCreateSprintForm() {
                document.getElementById('noSprintLanding').classList.add('hidden');
                document.getElementById('sprintConfigForm').classList.remove('hidden');
                document.getElementById('saveConfigBtn').classList.remove('hidden'); // Show save button
                
                // Auto-expand Core Configuration section for new sprint
                const coreConfigContent = document.getElementById('coreConfigContent');
                if (coreConfigContent && coreConfigContent.classList.contains('hidden')) {
                    toggleSection('coreConfigContent');
                }
            }
            
            // Smart Checklist System - Track Completion Status
            let completionState = {
                coreConfig: false,
                sprintMeetings: false,
                sprintEvents: false
            };
            
            let isNewSprint = true; // Will be set based on whether sprint exists
            let autoSaveDebounceTimer = null;
            
            // Check if Core Configuration is complete
            function isCoreConfigComplete() {
                const startDate = document.getElementById('startDate').value;
                const duration = document.getElementById('duration').value;
                return !!(startDate && duration && parseInt(duration) > 0);
            }
            
            // Check if Sprint Meetings has any configured
            function hasSprintMeetings() {
                const planningDate = document.getElementById('planningDate').value;
                const groomingDate = document.getElementById('groomingDate').value;
                const retrospectiveDate = document.getElementById('retrospectiveDate').value;
                return !!(planningDate || groomingDate || retrospectiveDate);
            }
            
            // Check if Sprint Events has any configured
            function hasSprintEvents() {
                return sprintHolidays.length > 0 || sprintDeployments.length > 0 || sprintCodeFreezes.length > 0;
            }
            
            // Update completion status and UI
            function updateCompletionStatus() {
                // Update state
                completionState.coreConfig = isCoreConfigComplete();
                completionState.sprintMeetings = hasSprintMeetings();
                completionState.sprintEvents = hasSprintEvents();
                
                // Update section badges (in collapsed headers)
                const coreConfigStatus = document.getElementById('coreConfigStatus');
                if (completionState.coreConfig) {
                    coreConfigStatus.textContent = 'âœ“ Complete';
                    coreConfigStatus.className = 'ml-2 px-2 py-0.5 text-xs font-semibold rounded-md bg-green-100 text-green-600';
                } else {
                    coreConfigStatus.textContent = 'Required';
                    coreConfigStatus.className = 'ml-2 px-2 py-0.5 text-xs font-semibold rounded-md bg-red-100 text-red-600';
                }
                
                const sprintMeetingsStatus = document.getElementById('sprintMeetingsStatus');
                if (completionState.sprintMeetings) {
                    sprintMeetingsStatus.textContent = 'âœ“ Complete';
                    sprintMeetingsStatus.className = 'ml-2 px-2 py-0.5 text-xs font-semibold rounded-md bg-green-100 text-green-600';
                } else {
                    sprintMeetingsStatus.textContent = 'Optional';
                    sprintMeetingsStatus.className = 'ml-2 px-2 py-0.5 text-xs font-semibold rounded-md bg-gray-100 text-gray-500';
                }
                
                const sprintEventsStatus = document.getElementById('sprintEventsStatus');
                if (completionState.sprintEvents) {
                    sprintEventsStatus.textContent = 'âœ“ Complete';
                    sprintEventsStatus.className = 'ml-2 px-2 py-0.5 text-xs font-semibold rounded-md bg-green-100 text-green-600';
                } else {
                    sprintEventsStatus.textContent = 'Optional';
                    sprintEventsStatus.className = 'ml-2 px-2 py-0.5 text-xs font-semibold rounded-md bg-gray-100 text-gray-500';
                }
                
                // Update Progress Stepper
                updateProgressStepper();
            }
            
            // Update visual progress stepper
            function updateProgressStepper() {
                // Step 1: Core Configuration
                const step1Circle = document.getElementById('step1Circle');
                const step1Icon = document.getElementById('step1Icon');
                const step1Status = document.getElementById('step1Status');
                const connector1 = document.getElementById('connector1');
                
                if (completionState.coreConfig) {
                    step1Circle.className = 'w-12 h-12 rounded-full border-2 border-green-500 bg-green-500 flex items-center justify-center transition-all duration-300';
                    step1Icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M20 6L9 17l-5-5"></path>';
                    step1Icon.className = 'w-7 h-7 text-white';
                    step1Status.textContent = 'Complete';
                    step1Status.className = 'text-xs text-green-600 font-medium mt-1';
                    connector1.className = 'flex-1 h-0.5 bg-green-500 mx-4 -mt-8 transition-all duration-300';
                } else {
                    step1Circle.className = 'w-12 h-12 rounded-full border-2 border-primary-500 bg-primary-50 flex items-center justify-center transition-all duration-300';
                    step1Icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>';
                    step1Icon.className = 'w-6 h-6 text-primary-600';
                    step1Status.textContent = 'Required - In Progress';
                    step1Status.className = 'text-xs text-primary-600 font-medium mt-1';
                    connector1.className = 'flex-1 h-0.5 bg-gray-200 mx-4 -mt-8 transition-all duration-300';
                }
                
                // Step 2: Sprint Meetings
                const step2Circle = document.getElementById('step2Circle');
                const step2Icon = document.getElementById('step2Icon');
                const step2Status = document.getElementById('step2Status');
                const connector2 = document.getElementById('connector2');
                
                if (completionState.sprintMeetings) {
                    step2Circle.className = 'w-12 h-12 rounded-full border-2 border-green-500 bg-green-500 flex items-center justify-center transition-all duration-300';
                    step2Icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M20 6L9 17l-5-5"></path>';
                    step2Icon.className = 'w-7 h-7 text-white';
                    step2Status.textContent = 'Complete';
                    step2Status.className = 'text-xs text-green-600 font-medium mt-1';
                    connector2.className = 'flex-1 h-0.5 bg-green-500 mx-4 -mt-8 transition-all duration-300';
                } else if (completionState.coreConfig) {
                    step2Circle.className = 'w-12 h-12 rounded-full border-2 border-primary-500 bg-white flex items-center justify-center transition-all duration-300';
                    step2Icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>';
                    step2Icon.className = 'w-6 h-6 text-primary-600';
                    step2Status.textContent = 'Optional - Ready';
                    step2Status.className = 'text-xs text-primary-600 font-medium mt-1';
                    connector2.className = 'flex-1 h-0.5 bg-gray-200 mx-4 -mt-8 transition-all duration-300';
                } else {
                    step2Circle.className = 'w-12 h-12 rounded-full border-2 border-gray-300 bg-white flex items-center justify-center transition-all duration-300';
                    step2Icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>';
                    step2Icon.className = 'w-6 h-6 text-gray-400';
                    step2Status.textContent = 'Optional - Pending';
                    step2Status.className = 'text-xs text-gray-500 mt-1';
                    connector2.className = 'flex-1 h-0.5 bg-gray-200 mx-4 -mt-8 transition-all duration-300';
                }
                
                // Step 3: Sprint Events
                const step3Circle = document.getElementById('step3Circle');
                const step3Icon = document.getElementById('step3Icon');
                const step3Status = document.getElementById('step3Status');
                
                if (completionState.sprintEvents) {
                    step3Circle.className = 'w-12 h-12 rounded-full border-2 border-green-500 bg-green-500 flex items-center justify-center transition-all duration-300';
                    step3Icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M20 6L9 17l-5-5"></path>';
                    step3Icon.className = 'w-7 h-7 text-white';
                    step3Status.textContent = 'Complete';
                    step3Status.className = 'text-xs text-green-600 font-medium mt-1';
                } else if (completionState.coreConfig) {
                    step3Circle.className = 'w-12 h-12 rounded-full border-2 border-primary-500 bg-white flex items-center justify-center transition-all duration-300';
                    step3Icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>';
                    step3Icon.className = 'w-6 h-6 text-primary-600';
                    step3Status.textContent = 'Optional - Ready';
                    step3Status.className = 'text-xs text-primary-600 font-medium mt-1';
                } else {
                    step3Circle.className = 'w-12 h-12 rounded-full border-2 border-gray-300 bg-white flex items-center justify-center transition-all duration-300';
                    step3Icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>';
                    step3Icon.className = 'w-6 h-6 text-gray-400';
                    step3Status.textContent = 'Optional - Pending';
                    step3Status.className = 'text-xs text-gray-500 mt-1';
                }
            }
            
            // Auto-expand next section when current is complete
            function smartAutoExpand(completedSection) {
                if (!isNewSprint) return; // Only for new sprints
                
                // If Core Config just completed, auto-expand Sprint Meetings
                if (completedSection === 'coreConfig' && !completionState.sprintMeetings) {
                    const coreConfigContent = document.getElementById('coreConfigContent');
                    const sprintMeetingsContent = document.getElementById('sprintMeetingsContent');
                    
                    // Collapse core config (with delay for smooth UX)
                    setTimeout(() => {
                        if (!coreConfigContent.classList.contains('hidden')) {
                            toggleSection('coreConfigContent');
                        }
                        // Expand Sprint Meetings
                        if (sprintMeetingsContent.classList.contains('hidden')) {
                            toggleSection('sprintMeetingsContent');
                        }
                    }, 800);
                }
                
                // If Sprint Meetings completed, suggest Sprint Events
                if (completedSection === 'sprintMeetings' && !completionState.sprintEvents) {
                    const sprintMeetingsContent = document.getElementById('sprintMeetingsContent');
                    const sprintEventsContent = document.getElementById('sprintEventsContent');
                    
                    setTimeout(() => {
                        if (!sprintMeetingsContent.classList.contains('hidden')) {
                            toggleSection('sprintMeetingsContent');
                        }
                        if (sprintEventsContent.classList.contains('hidden')) {
                            toggleSection('sprintEventsContent');
                        }
                    }, 800);
                }
            }
            
            // Auto-save with debounce
            function triggerAutoSave(completedSection, showPendingMessage = false) {
                if (!completionState.coreConfig) {
                    // Show helpful message for events added before Core Config is complete
                    if (showPendingMessage) {
                        console.log('â³ Event added locally. Complete Core Configuration to save.');
                        showWarning('Event added. Complete Core Configuration to save changes.');
                    }
                    return; // Don't auto-save until core config is complete
                }
                
                clearTimeout(autoSaveDebounceTimer);
                autoSaveDebounceTimer = setTimeout(() => {
                    console.log('ðŸ”„ Auto-saving configuration...');
                    
                    // Check if this is a new sprint or existing sprint
                    const sprintId = getCurrentSprintId();
                    
                    if (!sprintId && isNewSprint) {
                        // New sprint - create it first with form values
                        const startDate = document.getElementById('startDate').value;
                        const duration = parseInt(document.getElementById('duration').value);
                        
                        if (startDate && duration && !isNaN(duration)) {
                            console.log('ðŸ“ Creating new sprint with:', startDate, duration);
                            createNewSprintAndSaveSettings(startDate, duration, true); // isAutoSave=true
                        } else {
                            console.warn('âš ï¸ Cannot auto-save: missing start date or duration');
                        }
                    } else if (sprintId) {
                        // Existing sprint - update it
                        console.log('ðŸ’¾ Updating existing sprint...');
                        const startDate = document.getElementById('startDate').value;
                        const duration = parseInt(document.getElementById('duration').value);
                        updateSprintConfiguration(sprintId, startDate, duration, true); // isAutoSave=true
                    }
                    
                    // Smart expand after a slight delay to allow save to complete
                    setTimeout(() => {
                        smartAutoExpand(completedSection);
                    }, 500);
                }, 1500); // Wait 1.5s after last change
            }
            
            // Initialize completion tracking on page load
            function initializeSmartChecklist() {
                // Detect if editing existing sprint
                const sprintId = getCurrentSprintId();
                isNewSprint = !sprintId;
                
                // Set up event listeners for Core Config fields
                document.getElementById('startDate').addEventListener('change', () => {
                    updateCompletionStatus();
                    if (isCoreConfigComplete()) {
                        triggerAutoSave('coreConfig');
                    }
                });
                
                document.getElementById('duration').addEventListener('change', () => {
                    updateCompletionStatus();
                    if (isCoreConfigComplete()) {
                        triggerAutoSave('coreConfig');
                    }
                });
                
                // Initial status update
                updateCompletionStatus();
                
                // If new sprint, expand Core Config by default
                if (isNewSprint) {
                    const coreConfigContent = document.getElementById('coreConfigContent');
                    if (coreConfigContent.classList.contains('hidden')) {
                        toggleSection('coreConfigContent');
                    }
                }
            }
            
            // REAL API Functions
            function calculateEndDate() {
                const startDate = document.getElementById('startDate').value;
                const duration = parseInt(document.getElementById('duration').value);
                
                if (startDate && duration) {
                    // Call real API to calculate working days
                    fetch('/api/sprint-setup/calculate-dates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            startDate: startDate,
                            duration: duration
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('endDate').value = data.data.endDate;
                            // âœ… Don't auto-populate freeze date - user decides if needed
                            updateTimeline();
                            updateDateRestrictions(); // âœ… Restrict date pickers to sprint range
                            // âœ… Fetch global holidays for this date range
                            loadGlobalHolidays(startDate, data.data.endDate);
                            console.log('Working days calculated:', data.data.workingDays);
                        } else {
                            console.error('Error calculating dates:', data.message);
                            // Fallback to simple calculation
                            fallbackCalculateEndDate(startDate, duration);
                        }
                    })
                    .catch(error => {
                        console.error('API error:', error);
                        // Fallback to simple calculation
                        fallbackCalculateEndDate(startDate, duration);
                    });
                }
            }
            
            function fallbackCalculateEndDate(startDate, duration) {
                const start = new Date(startDate);
                const end = new Date(start);
                end.setDate(start.getDate() + duration);
                
                const endDateStr = end.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDateStr;
                // âœ… Don't auto-populate freeze date - user decides if needed
                
                updateTimeline();
                updateDateRestrictions(); // âœ… Restrict date pickers to sprint range
                // âœ… Fetch global holidays for this date range
                loadGlobalHolidays(startDate, endDateStr);
            }
            
            /**
             * Load global/pre-configured holidays for the given date range
             * These holidays are ALWAYS included in the sprint
             */
            async function loadGlobalHolidays(startDate, endDate) {
                try {
                    const response = await fetch(`/api/sprint-setup/holidays?startDate=${startDate}&endDate=${endDate}`);
                    const data = await response.json();
                    
                    if (data.success && data.data && data.data.length > 0) {
                        globalHolidays = data.data;
                        
                        // âœ… Auto-select ALL global holidays (they are mandatory)
                        selectedGlobalHolidayIds.clear();
                        globalHolidays.forEach(holiday => {
                            selectedGlobalHolidayIds.add(holiday.id);
                        });
                        
                        // Show the global holidays section
                        document.getElementById('globalHolidaysSection').classList.remove('hidden');
                        renderGlobalHolidays();
                        updateTimeline(); // âœ… Update timeline immediately after loading
                        console.log('âœ… Loaded', globalHolidays.length, 'global holidays (auto-included)');
                    } else {
                        // Hide the section if no global holidays
                        document.getElementById('globalHolidaysSection').classList.add('hidden');
                        globalHolidays = [];
                        selectedGlobalHolidayIds.clear();
                        updateTimeline(); // âœ… Update timeline even when no holidays
                        console.log('No global holidays found for this date range');
                    }
                } catch (error) {
                    console.error('Error loading global holidays:', error);
                    document.getElementById('globalHolidaysSection').classList.add('hidden');
                }
            }
            
            /**
             * Render global holidays (always included, no checkboxes)
             */
            function renderGlobalHolidays() {
                const container = document.getElementById('globalHolidaysList');
                if (globalHolidays.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">No global holidays in this sprint period</p>';
                    return;
                }
                
                container.innerHTML = globalHolidays.map(holiday => {
                    // âœ… Enhanced date parsing - handle multiple formats
                    // Backend returns 'holidayDate' field (not 'date')
                    const dateValue = holiday.holidayDate || holiday.date;
                    let dateStr = 'Invalid Date';
                    
                    try {
                        if (Array.isArray(dateValue)) {
                            // Handle array format [2024, 12, 25] from backend
                            const [year, month, day] = dateValue;
                            const dateObj = new Date(year, month - 1, day);
                            dateStr = dateObj.toLocaleDateString('en-US', { 
                                month: 'short', day: 'numeric', year: 'numeric' 
                            });
                        } else if (typeof dateValue === 'string') {
                            // Handle string formats
                            if (dateValue.includes('-')) {
                                // Format: "2024-12-25"
                                const parts = dateValue.split('-');
                                if (parts.length === 3) {
                                    const dateObj = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                                    dateStr = dateObj.toLocaleDateString('en-US', { 
                                        month: 'short', day: 'numeric', year: 'numeric' 
                                    });
                                }
                            } else if (dateValue.includes('/')) {
                                // Format: "12/25/2024"
                                const dateObj = new Date(dateValue);
                                dateStr = dateObj.toLocaleDateString('en-US', { 
                                    month: 'short', day: 'numeric', year: 'numeric' 
                                });
                            } else {
                                // Try generic parse
                                const dateObj = new Date(dateValue);
                                if (!isNaN(dateObj.getTime())) {
                                    dateStr = dateObj.toLocaleDateString('en-US', { 
                                        month: 'short', day: 'numeric', year: 'numeric' 
                                    });
                                }
                            }
                        } else if (typeof dateValue === 'object' && dateValue !== null) {
                            // Handle date object
                            const dateObj = new Date(dateValue);
                            if (!isNaN(dateObj.getTime())) {
                                dateStr = dateObj.toLocaleDateString('en-US', { 
                                    month: 'short', day: 'numeric', year: 'numeric' 
                                });
                            }
                        }
                        
                        console.log('Holiday date parsing:', holiday.name, 'Raw:', dateValue, 'Parsed:', dateStr);
                    } catch (error) {
                        console.error('Error parsing holiday date:', holiday, error);
                        dateStr = 'Invalid Date';
                    }
                    
                    return `
                    <div class="flex items-center gap-3 p-3 rounded-lg bg-yellow-50 border border-yellow-200/80">
                        <div class="flex-shrink-0">
                            <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800 text-sm">${holiday.name}</p>
                            <p class="text-xs text-gray-500">${dateStr}</p>
                        </div>
                        <span class="text-xs bg-yellow-600 text-white px-2.5 py-1 rounded-full font-medium">Auto-included</span>
                    </div>
                    `;
                }).join('');
            }
            
            /**
             * Note: Global holidays are now always included (no toggle needed)
             * This function is kept for compatibility but does nothing
             */
            function toggleGlobalHoliday(holidayId) {
                // Global holidays are mandatory - no action needed
                console.log('Global holidays are always included');
            }
            
            /**
             * Get all holidays for display (global + custom)
             * Used for timeline and calculations
             */
            function getAllHolidaysForDisplay() {
                const allHolidays = [];
                
                // Add selected global holidays (using holidayDate field from backend)
                globalHolidays.forEach(holiday => {
                    if (selectedGlobalHolidayIds.has(holiday.id)) {
                        allHolidays.push({
                            id: holiday.id,
                            date: holiday.holidayDate || holiday.date,
                            name: holiday.name,
                            isGlobal: true // âœ… Mark as global
                        });
                    }
                });
                
                // Add custom holidays
                sprintHolidays.forEach(holiday => {
                    allHolidays.push({
                        ...holiday,
                        isGlobal: false // âœ… Mark as custom
                    });
                });
                
                return allHolidays;
            }
            
            /**
             * Get ONLY custom holidays for saving to sprint_event table
             * Global holidays are NOT saved (already in holiday table)
             */
            function getCustomHolidaysForSaving() {
                // âœ… Return only custom holidays (not global ones)
                return sprintHolidays;
            }
            
            /**
             * Restrict all date pickers to the sprint date range
             * Prevents users from selecting dates outside the sprint boundaries
             */
            function updateDateRestrictions() {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    console.log('âš ï¸ Cannot set date restrictions: start or end date not available');
                    return;
                }
                
                // List of all date input fields that should be restricted to sprint range
                const restrictedDateFields = [
                    'planningDate',        // Sprint Planning meeting
                    'groomingDate',        // Backlog Grooming meeting
                    'retrospectiveDate',   // Sprint Retrospective meeting
                    'newHolidayDate',      // Holiday date picker
                    'newDeploymentDate',   // Deployment date picker
                    'newCodeFreezeDate'    // Code Freeze date picker
                ];
                
                // Apply min/max restrictions to each field
                restrictedDateFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.setAttribute('min', startDate);
                        field.setAttribute('max', endDate);
                        
                        // If current value is outside range, clear it
                        const currentValue = field.value;
                        if (currentValue && (currentValue < startDate || currentValue > endDate)) {
                            field.value = '';
                            console.log(`âš ï¸ Cleared ${fieldId} - date was outside sprint range`);
                        }
                    }
                });
                
                console.log(`âœ… Date restrictions applied: ${startDate} to ${endDate}`);
            }
            
            function updateTimeline() {
                const startDateStr = document.getElementById('startDate').value;
                const endDateStr = document.getElementById('endDate').value;
                
                if (!startDateStr) {
                    return; // Can't build timeline without start date
                }
                
                const startDate = new Date(startDateStr);
                const endDate = endDateStr ? new Date(endDateStr) : null;
                
                // Collect ALL timeline events with dates
                const allEvents = [];
                
                // 1. Sprint Start
                allEvents.push({
                    date: new Date(startDate),
                    time: null,
                    sortOrder: 0,
                    type: 'sprint-start',
                    title: 'Sprint Start',
                    icon: 'sprint-start',
                    iconColor: 'text-green-500',
                    dotColor: 'border-primary-500 bg-primary-500'
                });
                
                // 2. Planning Meeting (only if date is set)
                const planningDateStr = document.getElementById('planningDate').value;
                const planningTimeStr = document.getElementById('planningTime').value;
                if (planningDateStr) {
                    allEvents.push({
                        date: new Date(planningDateStr),
                        time: planningTimeStr || '10:00',
                        sortOrder: 1,
                        type: 'meeting',
                        title: 'Meeting: Planning',
                        icon: 'users',
                        iconColor: 'text-blue-500',
                        dotColor: 'border-primary-500 bg-primary-500'
                    });
                }
                
                // 3. Grooming Meeting (only if date is set)
                const groomingDateStr = document.getElementById('groomingDate').value;
                const groomingTimeStr = document.getElementById('groomingTime').value;
                if (groomingDateStr) {
                    allEvents.push({
                        date: new Date(groomingDateStr),
                        time: groomingTimeStr || '14:00',
                        sortOrder: 2,
                        type: 'meeting',
                        title: 'Meeting: Grooming',
                        icon: 'users',
                        iconColor: 'text-blue-500',
                        dotColor: 'border-primary-500 bg-primary-500'
                    });
                }
                
                // 4. Retrospective Meeting (only if date is set)
                const retrospectiveDateStr = document.getElementById('retrospectiveDate').value;
                const retrospectiveTimeStr = document.getElementById('retrospectiveTime').value;
                if (retrospectiveDateStr) {
                    allEvents.push({
                        date: new Date(retrospectiveDateStr),
                        time: retrospectiveTimeStr || '15:00',
                        sortOrder: 8,
                        type: 'meeting',
                        title: 'Meeting: Retrospective',
                        icon: 'users',
                        iconColor: 'text-blue-500',
                        dotColor: 'border-primary-500 bg-primary-500'
                    });
                }
                
                // 5. Add code freeze dates
                sprintCodeFreezes.forEach(codeFreeze => {
                    allEvents.push({
                        date: new Date(codeFreeze.date),
                        time: null,
                        sortOrder: 3,
                        type: 'freeze',
                        title: 'ðŸ”’ Code Freeze' + (codeFreeze.name ? ': ' + codeFreeze.name : ''),
                        icon: 'lock',
                        iconColor: 'text-orange-500',
                        dotColor: 'border-orange-500 bg-orange-500'
                    });
                });
                
                // 6. Add holidays (both global and custom for display)
                const allHolidays = getAllHolidaysForDisplay();
                allHolidays.forEach(holiday => {
                    // Parse date properly - could be string, array, or object
                    let holidayDate;
                    const dateValue = holiday.date;
                    
                    if (Array.isArray(dateValue)) {
                        const [year, month, day] = dateValue;
                        holidayDate = new Date(year, month - 1, day);
                    } else if (typeof dateValue === 'string') {
                        if (dateValue.includes('-')) {
                            const parts = dateValue.split('-');
                            holidayDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                        } else {
                            holidayDate = new Date(dateValue);
                        }
                    } else {
                        holidayDate = new Date(dateValue);
                    }
                    
                    allEvents.push({
                        date: holidayDate,
                        time: null,
                        sortOrder: 6,
                        type: 'holiday',
                        title: 'ðŸ–ï¸ Holiday: ' + holiday.name,
                        icon: 'sun',
                        iconColor: 'text-yellow-500',
                        dotColor: 'border-yellow-500 bg-yellow-500'
                    });
                });
                
                // 7. Add deployments
                sprintDeployments.forEach(deployment => {
                    allEvents.push({
                        date: new Date(deployment.date),
                        time: null,
                        sortOrder: 5,
                        type: 'deployment',
                        title: 'ðŸš€ Deployment: ' + deployment.name,
                        icon: 'rocket',
                        iconColor: 'text-green-500',
                        dotColor: 'border-green-500 bg-green-500'
                    });
                });
                
                // 8. Sprint End (if set) - Always last with sortOrder 99
                if (endDate) {
                    allEvents.push({
                        date: new Date(endDate),
                        time: null,
                        sortOrder: 99, // âœ… Highest value ensures Sprint End is always last on its day
                        type: 'sprint-end',
                        title: 'Sprint End',
                        icon: 'sprint-end',
                        iconColor: 'text-red-500',
                        dotColor: 'border-primary-500 bg-primary-500'
                    });
                }
                
                // Sort events chronologically (by date first, then by sortOrder for same-day events)
                allEvents.sort((a, b) => {
                    const dateCompare = a.date.getTime() - b.date.getTime();
                    if (dateCompare !== 0) return dateCompare;
                    return a.sortOrder - b.sortOrder;
                });
                
                // Render timeline
                renderTimeline(allEvents);
            }
            
            function renderTimeline(events) {
                const container = document.getElementById('timelineContainer');
                if (!container) return;
                
                container.innerHTML = '';
                
                events.forEach((event, index) => {
                    const dateStr = event.date.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    
                    const timeStr = event.time ? ` at ${event.time}` : '';
                    
                    // Determine if this is a major milestone (Sprint Start or End)
                    const isMajorMilestone = event.type === 'sprint-start' || event.type === 'sprint-end';
                    
                    // Choose appropriate SVG icon - Enhanced & Attractive
                    let svgIcon = '';
                    if (event.icon === 'sprint-start') {
                        // Rocket launching - exciting start!
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>';
                    } else if (event.icon === 'sprint-end') {
                        // Flag at finish line
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>';
                    } else if (event.icon === 'users') {
                        // Team meeting icon
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>';
                    } else if (event.icon === 'lock') {
                        // Code freeze lock
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>';
                    } else if (event.icon === 'rocket') {
                        // Deployment rocket
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>';
                    } else if (event.icon === 'sun') {
                        // Holiday sun icon
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
                    } else {
                        // Default calendar icon
                        svgIcon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>';
                    }
                    
                    // Different styling for major milestones vs regular events
                    let eventHtml = '';
                    if (isMajorMilestone) {
                        // Major Milestone: Sprint Start or Sprint End
                        const milestoneColor = event.type === 'sprint-start' ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-green-200' : 'bg-gradient-to-r from-red-50 to-rose-50 border-red-200';
                        const badgeColor = event.type === 'sprint-start' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const iconSize = 'w-6 h-6';
                        const dotSize = 'h-7 w-7';
                        const innerDotSize = 'h-3 w-3';
                        
                        eventHtml = `
                            <div class="relative flex items-start space-x-4 ${milestoneColor} border-2 rounded-xl p-4 shadow-sm mb-2">
                                <div class="absolute left-[-30px] top-5 bg-white ${dotSize} rounded-full border-3 ${event.dotColor} flex items-center justify-center shadow-md">
                                    <div class="${innerDotSize} ${event.dotColor.replace('border-', 'bg-').split(' ')[0]} rounded-full"></div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${badgeColor} uppercase tracking-wide">
                                            ${event.type === 'sprint-start' ? 'ðŸš€ Milestone' : 'ðŸ Milestone'}
                                        </span>
                                    </div>
                                    <p class="text-xl font-extrabold text-gray-900 mb-1">${event.title}</p>
                                    <p class="text-base text-gray-600 flex items-center space-x-2">
                                        <svg class="${iconSize} ${event.iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            ${svgIcon}
                                        </svg>
                                        <span class="font-semibold">${dateStr}${timeStr}</span>
                                    </p>
                                </div>
                            </div>
                        `;
                    } else {
                        // Regular Event: Meetings, Deployments, Holidays, etc.
                        eventHtml = `
                            <div class="relative flex items-start space-x-4 ml-4">
                                <div class="absolute left-[-30px] top-0.5 bg-white h-5 w-5 rounded-full border-2 ${event.dotColor} flex items-center justify-center">
                                    <div class="h-2 w-2 ${event.dotColor.replace('border-', 'bg-').split(' ')[0]} rounded-full"></div>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">${event.title}</p>
                                    <p class="text-sm text-gray-500 flex items-center space-x-1.5">
                                        <svg class="w-4 h-4 ${event.iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            ${svgIcon}
                                        </svg>
                                        <span>${dateStr}${timeStr}</span>
                                    </p>
                                </div>
                            </div>
                        `;
                    }
                    
                    container.insertAdjacentHTML('beforeend', eventHtml);
                });
            }
            
            function saveSprintSettings() {
                const startDate = document.getElementById('startDate').value;
                const duration = parseInt(document.getElementById('duration').value);
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !duration) {
                    showError('Please fill in start date and duration first');
                    return;
                }
                
                // Get current sprint ID - if none exists, create a new sprint first
                const sprintId = getCurrentSprintId();
                
                if (!sprintId) {
                    // No active sprint - create new sprint first, then save configuration
                    createNewSprintAndSaveSettings(startDate, duration);
                } else {
                    // Active sprint exists - update configuration
                    updateSprintConfiguration(sprintId, startDate, duration);
                }
            }
            
            function createNewSprintAndSaveSettings(startDate, duration, isAutoSave = false) {
                // Get sprint name from input (can be null/empty for auto-generation)
                const sprintName = document.getElementById('sprintName').value.trim() || null;
                
                // Create new sprint first
                fetch('/api/sprints/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sprintName: sprintName,
                        startDate: startDate,
                        duration: duration, // Already parsed as int before passing to this function
                        status: 'ACTIVE'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const newSprintId = data.data.id;
                        console.log('âœ… New sprint created:', newSprintId);
                        
                        // Update the page context and set cookie with 7-day expiry
                        window.currentSprintId = newSprintId;
                        CookieUtils.setCookie('currentSprintId', newSprintId, 7);
                        
                        // Update flag - no longer a new sprint
                        isNewSprint = false;
                        
                        // Show success notification (only for manual saves)
                        if (!isAutoSave) {
                            showSuccess('âœ“ Sprint created successfully');
                        }
                        
                        // Now save the detailed configuration
                        updateSprintConfiguration(newSprintId, startDate, duration, isAutoSave);
                    } else {
                        showError('Error creating new sprint: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error creating sprint:', error);
                    showError('Failed to create new sprint');
                });
            }
            
            function updateSprintConfiguration(sprintId, startDate, duration, isAutoSave = false) {
                // Get sprint name from input (can be null/empty for keeping current or auto-generation)
                const sprintName = document.getElementById('sprintName').value.trim() || null;
                
                // Collect all meeting data
                const meetings = {
                    planning: {
                        date: document.getElementById('planningDate').value,
                        time: document.getElementById('planningTime').value,
                        duration: parseInt(document.getElementById('planningDuration').value)
                    },
                    grooming: {
                        date: document.getElementById('groomingDate').value,
                        time: document.getElementById('groomingTime').value,
                        duration: parseInt(document.getElementById('groomingDuration').value)
                    },
                    retrospective: {
                        date: document.getElementById('retrospectiveDate').value,
                        time: document.getElementById('retrospectiveTime').value,
                        duration: parseInt(document.getElementById('retrospectiveDuration').value)
                    }
                };
                
                // Save complete sprint configuration including holidays, deployments, code freezes, and meetings in one API call
                fetch(`/api/sprint-setup/${sprintId}/configuration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sprintName: sprintName,
                        startDate: startDate,
                        duration: duration, // Already parsed as int before passing to this function
                        holidays: getCustomHolidaysForSaving(), // âœ… Save ONLY custom holidays (not global)
                        deployments: sprintDeployments,
                        codeFreezes: sprintCodeFreezes,
                        meetings: meetings
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show appropriate success message
                        if (isAutoSave) {
                            showSuccess('âœ“ Auto-saved');
                        } else {
                            showSuccess('Sprint configuration saved successfully!');
                        }
                        
                        // Reload sprint data to show updated state (stay on same page)
                        setTimeout(() => {
                            loadSprintData();
                        }, 500);
                        
                    } else {
                        showError('Error saving sprint settings: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('Failed to save sprint settings');
                });
            }
            
            // Global variable to store current invite data for Outlook
            let currentInviteData = null;
            
            function generateInvite(meetingType) {
                // Check if meeting has date/time before generating invite
                const date = document.getElementById(meetingType + 'Date').value;
                const time = document.getElementById(meetingType + 'Time').value;
                
                if (!date || !time) {
                    showWarning('Please set meeting date and time first, then click Save to persist it.');
                    return;
                }
                
                // Generate AI invite (meeting should already be saved via configuration endpoint)
                openInviteModal(meetingType);
                generateAIInvite(meetingType);
            }
            
            function openInviteModal(meetingType) {
                // Set meeting type label
                const labels = {
                    'planning': 'Sprint Planning Meeting',
                    'grooming': 'Backlog Grooming Meeting',
                    'retrospective': 'Sprint Retrospective Meeting'
                };
                document.getElementById('inviteMeetingType').textContent = labels[meetingType] || 'Sprint Meeting';
                
                // Show modal with loading state
                document.getElementById('inviteModal').classList.remove('hidden');
                document.getElementById('inviteLoading').classList.remove('hidden');
                document.getElementById('inviteContent').classList.add('hidden');
            }
            
            function closeInviteModal() {
                document.getElementById('inviteModal').classList.add('hidden');
                currentInviteData = null;
            }
            
            async function generateAIInvite(meetingType) {
                const sprintId = getCurrentSprintId();
                if (!sprintId) {
                    showError('No active sprint found');
                    closeInviteModal();
                    return;
                }
                
                try {
                    const response = await fetch(`/api/sprint-setup/${sprintId}/meetings/${meetingType}/generate-invite`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        // Store invite data for Outlook
                        currentInviteData = data.data;
                        
                        // Populate modal fields
                        document.getElementById('inviteSubject').value = data.data.subject || 'Sprint Meeting';
                        document.getElementById('inviteDate').value = formatDate(data.data.date);
                        document.getElementById('inviteTime').value = formatTime(data.data.time);
                        document.getElementById('inviteDuration').value = data.data.duration + ' min';
                        
                        // Store body in hidden textarea and display in formatted div
                        const bodyContent = data.data.body || data.data.rawInvite;
                        document.getElementById('inviteBody').value = bodyContent;
                        document.getElementById('inviteBodyDisplay').textContent = bodyContent;
                        
                        // Show content, hide loading
                        document.getElementById('inviteLoading').classList.add('hidden');
                        document.getElementById('inviteContent').classList.remove('hidden');
                        
                        showSuccess('AI invite generated successfully!');
                    } else {
                        showError(data.message || 'Failed to generate AI invite');
                        closeInviteModal();
                    }
                } catch (error) {
                    console.error('Error generating AI invite:', error);
                    showError('Error generating AI invite');
                    closeInviteModal();
                }
            }
            
            function copyInviteToClipboard() {
                const subject = document.getElementById('inviteSubject').value;
                const body = document.getElementById('inviteBody').value;
                const fullText = `Subject: ${subject}\n\n${body}`;
                
                navigator.clipboard.writeText(fullText).then(() => {
                    showSuccess('Invite copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    showError('Failed to copy invite');
                });
            }
            
            function openInOutlook() {
                if (!currentInviteData) {
                    showError('No invite data available');
                    return;
                }
                
                // Convert date and time to ISO format for Outlook
                const date = currentInviteData.date;
                const time = currentInviteData.time || '10:00:00';
                const duration = parseInt(currentInviteData.duration) || 60;
                
                // Create start and end times
                const startDateTime = new Date(`${date}T${time}`);
                const endDateTime = new Date(startDateTime.getTime() + duration * 60000);
                
                // Format dates for Outlook (ISO 8601)
                const startISO = startDateTime.toISOString();
                const endISO = endDateTime.toISOString();
                
                // Get subject
                const subject = encodeURIComponent(currentInviteData.subject || 'Sprint Meeting');
                
                // Format body for Outlook - convert to HTML for better formatting
                let bodyText = currentInviteData.body || currentInviteData.rawInvite;
                
                // Convert plain text to HTML for Outlook
                const bodyHTML = convertTextToHTML(bodyText);
                const body = encodeURIComponent(bodyHTML);
                
                // Create Outlook Web URL
                const outlookUrl = `https://outlook.office.com/calendar/0/deeplink/compose?`
                    + `subject=${subject}`
                    + `&body=${body}`
                    + `&startdt=${startISO}`
                    + `&enddt=${endISO}`
                    + `&path=/calendar/action/compose`;
                
                // Open in new window
                window.open(outlookUrl, '_blank');
                
                showSuccess('Opening in Outlook...');
            }
            
            function convertTextToHTML(text) {
                if (!text) return '';
                
                // Split into lines
                const lines = text.split('\n');
                let html = '<div style="font-family: Calibri, Arial, sans-serif; font-size: 11pt; color: #000000;">';
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (line === '') {
                        // Empty line = line break
                        html += '<br>';
                    } else if (line.endsWith(':')) {
                        // Section headers (AGENDA:, MEETING DETAILS:, etc.)
                        html += `<p style="margin: 12px 0 6px 0; font-weight: bold; font-size: 12pt; color: #1a73e8;">${escapeHtml(line)}</p>`;
                    } else if (line.match(/^\d+\./)) {
                        // Numbered list items
                        html += `<p style="margin: 4px 0 4px 20px;">${escapeHtml(line)}</p>`;
                    } else if (line.startsWith('Date:') || line.startsWith('Time:') || line.startsWith('Duration:')) {
                        // Meeting detail lines
                        html += `<p style="margin: 4px 0 4px 20px; color: #5f6368;">${escapeHtml(line)}</p>`;
                    } else {
                        // Regular paragraph
                        html += `<p style="margin: 8px 0;">${escapeHtml(line)}</p>`;
                    }
                }
                
                html += '</div>';
                return html;
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Helper functions for date/time formatting
            function formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
            
            function formatTime(timeStr) {
                if (!timeStr) return '';
                // Handle both "HH:MM:SS" and "HH:MM" formats
                const parts = timeStr.split(':');
                const hours = parseInt(parts[0]);
                const minutes = parts[1];
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12;
                return `${displayHours}:${minutes} ${ampm}`;
            }
            
            // Meeting data is now saved via the /configuration endpoint
            // No separate saveMeetingData function needed
            
            // Holiday Management Functions
            function addHoliday() {
                const dateInput = document.getElementById('newHolidayDate');
                const nameInput = document.getElementById('newHolidayName');
                
                const date = dateInput.value;
                const name = nameInput.value.trim();
                
                if (!date || !name) {
                    showError('Please enter both holiday date and name');
                    return;
                }
                
                const holiday = {
                    id: 'holiday-' + Date.now(),
                    date: date,
                    name: name
                };
                
                sprintHolidays.push(holiday);
                dateInput.value = '';
                nameInput.value = '';
                renderHolidays();
                updateTimeline();
                updateCompletionStatus();
                triggerAutoSave('sprintEvents', true); // Auto-save after adding holiday (show pending message)
                console.log('âœ… Holiday added:', holiday);
            }
            
            function removeHoliday(holidayId) {
                sprintHolidays = sprintHolidays.filter(h => h.id !== holidayId);
                renderHolidays();
                updateTimeline();
                updateCompletionStatus();
                triggerAutoSave('sprintEvents', true); // Auto-save after removing holiday (show pending message)
            }
            
            function renderHolidays() {
                const container = document.getElementById('holidaysList');
                console.log('ðŸŽ¨ Rendering custom holidays:', sprintHolidays.length);
                if (sprintHolidays.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No custom holidays added</p>';
                    return;
                }
                container.innerHTML = sprintHolidays.map(holiday => `
                    <div class="flex items-center justify-between p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-800">${holiday.name}</p>
                            <p class="text-xs text-gray-500">${new Date(holiday.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                        </div>
                        <button onclick="removeHoliday('${holiday.id}')" class="text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `).join('');
            }
            
            // Deployment Management Functions
            function addDeployment() {
                const dateInput = document.getElementById('newDeploymentDate');
                const nameInput = document.getElementById('newDeploymentName');
                
                const date = dateInput.value;
                const name = nameInput.value.trim();
                
                if (!date || !name) {
                    showError('Please enter both deployment date and name');
                    return;
                }
                
                const deployment = {
                    id: 'deployment-' + Date.now(),
                    date: date,
                    name: name
                };
                
                sprintDeployments.push(deployment);
                dateInput.value = '';
                nameInput.value = '';
                renderDeployments();
                updateTimeline();
                updateCompletionStatus();
                triggerAutoSave('sprintEvents', true); // Auto-save after adding deployment (show pending message)
                console.log('âœ… Deployment added:', deployment);
            }
            
            function removeDeployment(deploymentId) {
                sprintDeployments = sprintDeployments.filter(d => d.id !== deploymentId);
                renderDeployments();
                updateTimeline();
                updateCompletionStatus();
                triggerAutoSave('sprintEvents', true); // Auto-save after removing deployment (show pending message)
            }
            
            // Code Freeze Management Functions
            function addCodeFreeze() {
                const dateInput = document.getElementById('newCodeFreezeDate');
                const nameInput = document.getElementById('newCodeFreezeName');
                
                const date = dateInput.value;
                const name = nameInput.value.trim();
                
                if (!date) {
                    showError('Please enter a code freeze date');
                    return;
                }
                
                const codeFreeze = {
                    id: 'freeze-' + Date.now(),
                    date: date,
                    name: name || 'Code Freeze'
                };
                
                sprintCodeFreezes.push(codeFreeze);
                dateInput.value = '';
                nameInput.value = '';
                renderCodeFreezes();
                updateTimeline();
                updateCompletionStatus();
                triggerAutoSave('sprintEvents', true); // Auto-save after adding code freeze (show pending message)
                console.log('âœ… Code freeze added:', codeFreeze);
            }
            
            function removeCodeFreeze(freezeId) {
                sprintCodeFreezes = sprintCodeFreezes.filter(f => f.id !== freezeId);
                renderCodeFreezes();
                updateTimeline();
                updateCompletionStatus();
                triggerAutoSave('sprintEvents', true); // Auto-save after removing code freeze (show pending message)
            }
            
            function renderCodeFreezes() {
                const container = document.getElementById('codeFreezeList');
                if (sprintCodeFreezes.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No code freeze dates added</p>';
                    return;
                }
                
                container.innerHTML = sprintCodeFreezes
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map(freeze => `
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg border border-orange-200 shadow-sm">
                        <div>
                            <p class="font-semibold text-gray-800">${freeze.name}</p>
                            <p class="text-xs text-gray-500">${new Date(freeze.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                        </div>
                        <button onclick="removeCodeFreeze('${freeze.id}')" class="text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                `).join('');
            }
            
            function renderDeployments() {
                const container = document.getElementById('deploymentsList');
                if (sprintDeployments.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No deployments scheduled</p>';
                    return;
                }
                container.innerHTML = sprintDeployments.map(deployment => `
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium text-gray-800">${deployment.name}</p>
                                <p class="text-xs text-gray-500">${new Date(deployment.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
                            </div>
                            <button onclick="removeDeployment('${deployment.id}')" class="text-red-500 hover:text-red-700">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            // NEW Sprint Management Functions - MINIMAL
            function startConfiguredSprint() {
                const startDate = document.getElementById('startDate').value;
                const duration = parseInt(document.getElementById('duration').value);
                
                if (!startDate || !duration) {
                    showError('Please configure sprint start date and duration first');
                    return;
                }
                
                if (confirm('Start sprint with current configuration?')) {
                    fetch('/api/sprints/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            startDate: startDate,
                            duration: duration,
                            status: 'ACTIVE'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess('Sprint started successfully!');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            showError('Error: ' + data.message);
                        }
                    });
                }
            }
            
            function showTemplateSelector() {
                document.getElementById('templateModal').classList.remove('hidden');
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('templateStartDate').value = today;
            }
            
            function closeTemplateModal(event) {
                if (!event || event.target === event.currentTarget) {
                    document.getElementById('templateModal').classList.add('hidden');
                    selectedTemplateId = null;
                    document.getElementById('applyTemplateBtn').disabled = true;
                }
            }
            
            function selectTemplate(templateId, duration) {
                selectedTemplateId = templateId;
                selectedTemplateDuration = duration;
                document.getElementById('applyTemplateBtn').disabled = false;
                
                // Highlight selected
                document.querySelectorAll('#templateModal .cursor-pointer').forEach(el => {
                    el.classList.remove('border-primary-500', 'bg-primary-100');
                    el.classList.add('border-gray-200');
                });
                event.target.closest('.cursor-pointer').classList.add('border-primary-500', 'bg-primary-100');
            }
            
            function applySelectedTemplate() {
                if (!selectedTemplateId) return;
                
                const startDate = document.getElementById('templateStartDate').value;
                if (!startDate) {
                    showError('Please select start date');
                    return;
                }
                
                // Apply template to form
                document.getElementById('startDate').value = startDate;
                document.getElementById('duration').value = selectedTemplateDuration;
                calculateEndDate();
                
                closeTemplateModal();
                showSuccess('Template applied! Configure and start when ready.');
            }
            
            function viewCurrentSprint(sprintId) {
                if (sprintId) window.location.href = '/sprint/' + sprintId;
            }
            
            function completeSprint(sprintId) {
                if (sprintId && confirm('Complete current sprint?')) {
                    fetch('/api/sprints/' + sprintId + '/complete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess('Sprint completed successfully!');
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            showError('Error: ' + data.message);
                        }
                    });
                }
            }
            
            // Helper Functions
            function getCurrentSprintId() {
                // Get from URL parameter or active sprint API
                const urlParams = new URLSearchParams(window.location.search);
                const sprintId = urlParams.get('sprintId');
                
                if (sprintId) {
                    return sprintId;
                }
                
                // Try to get current active sprint ID from the page context
                // This should be set by the backend when rendering the page
                const contextSprintId = window.currentSprintId;
                if (contextSprintId && contextSprintId !== 'null') {
                    return contextSprintId;
                }
                
                return null;
            }
            
            function loadTimelineData() {
                const sprintId = getCurrentSprintId();
                if (!sprintId) {
                    console.log('No sprint ID available for timeline');
                    return;
                }
                
                fetch(`/api/sprint-setup/${sprintId}/timeline`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updateTimelineWithEvents(data.data);
                        } else {
                            console.error('Error loading timeline:', data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading timeline:', error);
                    });
            }
            
            // Timeline and meetings are now loaded via loadSprintData() function
            // No separate updateTimelineWithEvents or loadMeetingData needed
            
            function loadSprintData() {
                console.log('ðŸ“¡ Checking for active sprint...');
                
                // Call API to check for active sprint
                fetch('/api/sprints/status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data.hasActiveSprint && data.data.currentSprint) {
                            const sprint = data.data.currentSprint;
                            console.log('âœ… Active sprint found:', sprint.id);
                            
                            // Store sprint ID globally and set cookie with 7-day expiry
                            window.currentSprintId = sprint.id;
                            CookieUtils.setCookie('currentSprintId', sprint.id, 7);
                            
                            // Populate form with sprint data
                            document.getElementById('sprintName').value = sprint.sprintName || '';
                            document.getElementById('startDate').value = sprint.startDate;
                            document.getElementById('duration').value = sprint.duration;
                            document.getElementById('endDate').value = sprint.endDate;
                            if (sprint.freezeDate) {
                                document.getElementById('freezeDate').value = sprint.freezeDate;
                            }
                            
                            // Extract holidays, deployments, and meetings from events array
                            if (sprint.events && Array.isArray(sprint.events)) {
                                // Filter holidays from events
                                const holidayEvents = sprint.events.filter(e => e.eventType === 'HOLIDAY');
                                
                                // âœ… Load global holidays FIRST, then separate them from custom ones
                                loadGlobalHolidays(sprint.startDate, sprint.endDate).then(() => {
                                    // After global holidays are loaded, identify which are global vs custom
                                    const globalHolidayIds = new Set(globalHolidays.map(h => h.id));
                                    
                                    // âœ… IMPORTANT: Only custom holidays should be in sprint_event table
                                    // Global holidays come from the holiday table and are NOT saved as sprint events
                                    sprintHolidays = [];
                                    
                                    holidayEvents.forEach(event => {
                                        if (globalHolidayIds.has(event.id)) {
                                            // This shouldn't happen (global holidays shouldn't be saved)
                                            // But if they are, mark them as selected and skip adding to custom
                                            console.warn('âš ï¸ Found global holiday in sprint events (should not be saved):', event.name);
                                            selectedGlobalHolidayIds.add(event.id);
                                        } else {
                                            // âœ… This is a custom holiday - add to sprintHolidays
                                            sprintHolidays.push({
                                                id: event.id,
                                                date: event.eventDate,
                                                name: event.name
                                            });
                                        }
                                    });
                                    
                                    // âœ… Now render both sections (no duplicates)
                                    renderHolidays();
                                    renderGlobalHolidays();
                                    updateTimeline(); // âœ… Update timeline after holidays are loaded
                                    
                                    console.log('ðŸ“… Loaded', sprintHolidays.length, 'custom holidays');
                                    console.log('ðŸŒ Showing', selectedGlobalHolidayIds.size, 'global holidays (from holiday table)');
                                });
                                
                                // Filter deployments from events
                                const deploymentEvents = sprint.events.filter(e => e.eventType === 'DEPLOYMENT');
                                sprintDeployments = deploymentEvents.map(e => ({
                                    id: e.id,
                                    date: e.eventDate,
                                    name: e.name
                                }));
                                renderDeployments();
                                console.log('ðŸš€ Loaded', sprintDeployments.length, 'deployments');
                                
                                // Filter code freeze dates from events
                                const codeFreezeEvents = sprint.events.filter(e => e.eventType === 'CODE_FREEZE');
                                sprintCodeFreezes = codeFreezeEvents.map(e => ({
                                    id: e.id,
                                    date: e.eventDate,
                                    name: e.name || 'Code Freeze'
                                }));
                                renderCodeFreezes();
                                console.log('ðŸ”’ Loaded', sprintCodeFreezes.length, 'code freezes');
                                
                                // Filter meetings from events and populate meeting fields
                                const meetingEvents = sprint.events.filter(e => e.eventType === 'MEETING');
                                meetingEvents.forEach(meeting => {
                                    const meetingType = meeting.eventSubtype ? meeting.eventSubtype.toLowerCase() : null;
                                    if (meetingType && ['planning', 'grooming', 'retrospective'].includes(meetingType)) {
                                        // Populate meeting fields
                                        const dateField = document.getElementById(meetingType + 'Date');
                                        const timeField = document.getElementById(meetingType + 'Time');
                                        const durationField = document.getElementById(meetingType + 'Duration');
                                        
                                        if (dateField && meeting.eventDate) dateField.value = meeting.eventDate;
                                        if (timeField && meeting.eventTime) timeField.value = meeting.eventTime;
                                        if (durationField && meeting.durationMinutes) durationField.value = meeting.durationMinutes;
                                        
                                        console.log(`ðŸ“… Loaded ${meetingType} meeting: ${meeting.eventDate} ${meeting.eventTime}`);
                                    }
                                });
                            }
                            
                            updateTimeline();
                            updateDateRestrictions(); // âœ… Restrict date pickers when loading existing sprint
                            updateSprintActionsSection(); // âœ… Show Sprint Actions section
                            
                            // Update smart checklist for editing mode
                            isNewSprint = false;
                            updateCompletionStatus();
                            console.log('ðŸ“‹ Sprint data populated in form (Editing mode)');
                        } else {
                            console.log('â„¹ï¸ No active sprint found - showing create sprint landing');
                            window.currentSprintId = null;
                            CookieUtils.deleteCookie('currentSprintId');
                            
                            // Set as new sprint mode
                            isNewSprint = true;
                            
                            // Show landing page instead of form
                            showNoSprintLanding();
                        }
                    })
                    .catch(error => {
                        console.error('âŒ Error checking for active sprint:', error);
                        console.log('Starting with blank form');
                        window.currentSprintId = null;
                        CookieUtils.deleteCookie('currentSprintId');
                    });
            }
            
            // Initialize
            document.addEventListener('DOMContentLoaded', function() {
                const today = new Date().toISOString().split('T')[0];
                
                console.log('ðŸš€ Sprint Setup page loaded');
                console.log('Current Sprint ID from backend:', window.currentSprintId);
                
                // Initialize holiday, deployment, and code freeze lists
                renderHolidays();
                renderDeployments();
                renderCodeFreezes();
                
                // Try to load existing sprint data first
                loadSprintData();
                
                // Initialize smart checklist system
                setTimeout(() => {
                    initializeSmartChecklist();
                }, 100);
                
                // Set defaults if no sprint data loaded
                setTimeout(() => {
                    if (!document.getElementById('startDate').value) {
                        console.log('Setting default start date:', today);
                        document.getElementById('startDate').value = today;
                        document.getElementById('duration').value = '10'; // Default to 10 days
                        calculateEndDate(); // This should work even without sprint ID
                    }
                    
                    updateCompletionStatus(); // Update completion status after defaults
                    console.log('âœ… Sprint Setup initialization complete');
                }, 500);
                
                // Add event listeners to meeting fields to update timeline dynamically
                const meetingFields = [
                    'planningDate', 'planningTime',
                    'groomingDate', 'groomingTime',
                    'retrospectiveDate', 'retrospectiveTime'
                ];
                
                meetingFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('change', function() {
                            console.log(`Meeting field ${fieldId} changed, updating timeline`);
                            updateTimeline();
                            updateCompletionStatus();
                            // Auto-save if a meeting date is set
                            if (fieldId.includes('Date') && field.value) {
                                triggerAutoSave('sprintMeetings');
                            }
                        });
                    }
                });
            });
            
            // ===== BEAUTIFUL TOAST NOTIFICATION SYSTEM =====
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toastContainer');
                const toastId = 'toast-' + Date.now();
                
                // Define toast styles based on type
                const styles = {
                    success: {
                        bg: 'bg-green-500',
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                              </svg>`,
                        iconBg: 'bg-green-600'
                    },
                    error: {
                        bg: 'bg-red-500',
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                              </svg>`,
                        iconBg: 'bg-red-600'
                    },
                    warning: {
                        bg: 'bg-yellow-500',
                        icon: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                              </svg>`,
                        iconBg: 'bg-yellow-600'
                    }
                };
                
                const style = styles[type] || styles.success;
                
                // Create toast element
                const toast = document.createElement('div');
                toast.id = toastId;
                toast.className = `${style.bg} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] max-w-md pointer-events-auto transform transition-all duration-300 ease-in-out translate-x-full opacity-0`;
                toast.innerHTML = `
                    <div class="flex items-center gap-3 flex-1">
                        <div class="${style.iconBg} rounded-full p-1 flex-shrink-0">
                            ${style.icon}
                        </div>
                        <p class="text-sm font-medium">${escapeHtmlForToast(message)}</p>
                    </div>
                    <button onclick="removeToast('${toastId}')" class="text-white hover:text-gray-200 transition-colors flex-shrink-0">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                
                toastContainer.appendChild(toast);
                
                // Trigger animation after a small delay to ensure CSS transition works
                setTimeout(() => {
                    toast.classList.remove('translate-x-full', 'opacity-0');
                }, 10);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    removeToast(toastId);
                }, 5000);
            }
            
            function removeToast(toastId) {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.classList.add('translate-x-full', 'opacity-0');
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }
            }
            
            function showSuccess(message) {
                showToast(message, 'success');
            }
            
            function showError(message) {
                showToast(message, 'error');
            }
            
            function showWarning(message) {
                showToast(message, 'warning');
            }
            
            function escapeHtmlForToast(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // ========================================
            // COMPLETE & ARCHIVE SPRINT FUNCTIONALITY
            // ========================================
            
            /**
             * Update Sprint Actions section with current sprint data
             */
            function updateSprintActionsSection() {
                const sprintId = getCurrentSprintId();
                console.log('ðŸ“Š Updating Sprint Actions section, sprintId:', sprintId);
                
                if (!sprintId) {
                    console.log('âš ï¸ No sprint ID, hiding Sprint Actions section');
                    document.getElementById('sprintActionsSection')?.classList.add('hidden');
                    return;
                }
                
                const startDate = document.getElementById('startDate')?.value;
                const endDate = document.getElementById('endDate')?.value;
                const duration = document.getElementById('duration')?.value;
                
                console.log('ðŸ“… Sprint data:', { startDate, endDate, duration });
                
                if (!startDate || !endDate) {
                    console.log('âš ï¸ Missing sprint dates, hiding section');
                    document.getElementById('sprintActionsSection')?.classList.add('hidden');
                    return;
                }
                
                // Show the section
                const actionsSection = document.getElementById('sprintActionsSection');
                if (actionsSection) {
                    actionsSection.classList.remove('hidden');
                    console.log('âœ… Sprint Actions section visible');
                }
                
                // Update display fields
                const periodDisplay = document.getElementById('sprintPeriodDisplay');
                const durationDisplay = document.getElementById('sprintDurationDisplay');
                
                if (periodDisplay) {
                    periodDisplay.textContent = `${formatDisplayDate(startDate)} - ${formatDisplayDate(endDate)}`;
                }
                
                if (durationDisplay) {
                    durationDisplay.textContent = `${duration} working days`;
                }
                
                // Button is always enabled - can complete sprint anytime
                const btn = document.getElementById('completeSprintBtn');
                if (btn) {
                    btn.disabled = false;
                    console.log('âœ… Complete Sprint button enabled');
                }
                
                // Hide warning message (no longer needed)
                const warning = document.getElementById('completionWarning');
                if (warning) {
                    warning.classList.add('hidden');
                }
            }
            
            /**
             * Format date for display (e.g., "Nov 17, 2025")
             */
            function formatDisplayDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
            }
            
            /**
             * Open the complete sprint confirmation modal
             */
            function openCompleteSprintModal() {
                const sprintId = getCurrentSprintId();
                if (!sprintId) {
                    showError('No active sprint found');
                    return;
                }
                
                // Populate modal with sprint data
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const duration = document.getElementById('duration').value;
                
                document.getElementById('modalSprintPeriod').textContent = 
                    `${formatDisplayDate(startDate)} - ${formatDisplayDate(endDate)}`;
                document.getElementById('modalSprintDuration').textContent = 
                    `${duration} working days`;
                
                // Count total events
                const eventCount = (sprintHolidays.length + sprintDeployments.length + 
                                   sprintCodeFreezes.length + 3); // +3 for potential meetings
                document.getElementById('modalEventCount').textContent = eventCount;
                
                // Show modal
                document.getElementById('completeSprintModal').classList.remove('hidden');
            }
            
            /**
             * Close the complete sprint confirmation modal
             */
            function closeCompleteSprintModal() {
                document.getElementById('completeSprintModal').classList.add('hidden');
            }
            
            /**
             * Archive sprint and create next sprint automatically
             */
            async function archiveSprintAndCreateNext() {
                const sprintId = getCurrentSprintId();
                if (!sprintId) {
                    showError('No active sprint found');
                    return;
                }
                
                // Disable button and show loading
                const btn = document.getElementById('confirmArchiveBtn');
                const originalContent = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Archiving...</span>
                `;
                
                try {
                    const response = await fetch(`/api/sprints/${sprintId}/complete-and-archive`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        // Close modal
                        closeCompleteSprintModal();
                        
                        // data.data contains the archived sprint
                        const archivedSprint = data.data;
                        
                        // Show success message
                        showSuccess(`Sprint "${archivedSprint.sprintName}" archived successfully!`);
                        
                        // Clear current sprint ID
                        window.currentSprintId = null;
                        CookieUtils.deleteCookie('currentSprintId');
                        
                        // Reload the page to show the "Create New Sprint" landing
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showError(data.message || 'Failed to complete sprint');
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }
                } catch (error) {
                    console.error('Error completing sprint:', error);
                    showError('Error completing sprint. Please try again.');
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            }
            
            // Update Sprint Actions section when sprint dates change
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('startDate')?.addEventListener('change', updateSprintActionsSection);
                document.getElementById('endDate')?.addEventListener('change', updateSprintActionsSection);
                document.getElementById('duration')?.addEventListener('change', updateSprintActionsSection);
            });
            
        </script>
    </div>
</body>
</html>